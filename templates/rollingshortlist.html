<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Previewing tables</title>
    <!-- Add Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f0f0;
        }

        .navbar {
            position: sticky;
            background-color: #f8f9fa;
            border-bottom: 1px solid #ddd;
            position: sticky;
            top: 0;
            z-index: 1000; /* Ensure Navbar is above other content */
        }

        .navbar-nav {
            margin-right: auto;
        }

        /* Add this CSS to style the displayed table */
        .table {
            width: 100%;
            border-collapse: collapse;
            position: relative;
        }

        .table th,
        .table td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }

        .table td {
            white-space: normal;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .table th {
            position: sticky;
            top: 0px; /* 63px for below navbar */
            background-color: #dbdbdb; /* Set the background color */
            color: black; /* Set the text color */
            z-index: 1001;
        }

        /* Add this CSS to adjust the layout when table is displayed */
        .table-details {
            max-width: 800px;
            padding: 0;
        }

        /* Add this CSS to change cell color when editing starts */
        .table td[contenteditable="true"]:focus {
            background-color: orange;
        }
        .table td.expanded div[contenteditable="true"]:focus {
            background-color: orange;
            padding: 8px;
            margin: -8px; /* Counteract padding to maintain cell size */
            border: 1px solid #ccc;
            white-space: normal;
            overflow: visible;
        }
        .table td.expanded {
            background-color: orange;
        }
        .table td.editing {
            background-color: orange;
        }

        .button-container {
            display: flex; /* Use flexbox to align buttons horizontally */
            align-items: center; /* Center items vertically within the container */
            margin-top: 10px; /* Adjust margin as needed */
        }

        .save-button,
        .add-row-button,
        .financials-button,
        .generate-assetpack-button {
            margin-right: 10px; /* Add space between buttons */
        }

        /* Add this CSS to style the "Expand" button */
        .expand-button {
            border-radius: 10px;
            border: none;
            display: inline-block;
            cursor: pointer;
        }


        /* for SLICER CONTAINER */
        .slicer-container {
            max-height: 150px;
            width: 200px;
            border: 1px solid #ccc;
            padding: 10px;
            overflow: auto; /* Enable vertical scrollbar when content overflows */
        }

        .slicer {
            margin-bottom: 10px;
            padding: 5px;
            border-radius: 5px;
        }

        .slicer-header {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .slicer-options label {
            display: block;
            margin-bottom: 3px;
        }

        /* Style checkboxes to make them more visible */
        .slicer-options input[type="checkbox"] {
            margin-right: 5px;
        }
        .slicer-options {
            white-space: nowrap; /* Prevent line breaks */
        }

        /* Style the column search input boxes */
        .column-search {
            width: 100%;
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        /* for loading animation */
        .loading-container {
            display: flex;
            justify-content: center;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8); /* Semi-transparent background */
            z-index: 9999; /* Higher z-index to cover the entire page */
        }


        .loading-animation {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <!-- Back Button -->
            <a class="navbar-brand" href="/preview">
                <img src="../static/images/left-arrow.png" alt="Back" width="30" height="30">
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Upload</a>
                    </li>
                    <li class="nav-item active">
                        <a class="nav-link" href="/model_testing">Model Testing</a>
                    </li>
                    <li class="nav-item active">
                        <a class="nav-link" href="/preview">Preview Tables</a>
                    </li>
                </ul>
            </div>

            <div class="button-container">
                <div class="table-name"></div>
                <div class="generate-assetpack-button"></div>
                <div class="add-row-button"></div>
                <div class="financials-button"></div>
                <div class="save-button"></div>
            </div>
        </div>
    </nav>

    <!-- Initial Modal for Financials -->
    <div class="modal fade" id="financialsModal" tabindex="-1" aria-labelledby="financialsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="financialsModalLabel">Select Financials to Scrape</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>You have selected <span id="selectedCount">0</span> number of Target's financials to be scraped. Proceed?</p>
                    <p>Targets selected:</p>
                    <ol id="selectedTargets"></ol>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" id="proceedAll">Proceed</button>
                    <button type="button" class="btn btn-secondary" id="individualScraping">Individual Scraping</button>
                    <button type="button" class="btn btn-danger" id="scrapeAll">Scrape ALL</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Second Modal for Individual Scraping of financials-->
    <div class="modal fade" id="individualModal" tabindex="-1" aria-labelledby="individualModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="individualModalLabel">Individual Scraping</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <label for="numInput">Num:</label>
                    <input type="number" id="numInput" class="form-control">
                    <div class="text-danger" id="NumvalidationError" style="display: none;">Num is not valid.</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="proceedIndividual">Proceed with Scraping</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Modal for generating Asset Pack -->
    <div class="modal fade" id="generateAPModal" tabindex="-1" aria-labelledby="generateAPModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="generateAPModalLabel">Generate Asset Pack</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <label for="targetNameInput">Target's name for Asset Pack generation:</label>
                    <input type="text" id="targetNameInput" class="form-control" placeholder="Enter Target's Name">
                    <div class="text-danger" id="validationError" style="display: none;">Target is not valid.</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" id="generateAssetPackButton" class="btn btn-primary">Generate</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Add a modal for adding a new row -->
    <div class="modal fade" id="addRowModal" tabindex="-1" aria-labelledby="addRowModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addRowModalLabel">Add Row</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="max-height: 400px; overflow-y: auto;">
                    <table class="table">
                        <thead>
                            <tr>
                                <!-- Header columns based on your specified order -->
                                <th>Num</th>
                                <th>Captured date</th>
                                <th>BP comments</th>
                                <th>Partner_or_Director</th>
                                <th>Target country</th>
                                <th>Sub sector</th>
                                <th>Source</th>
                                <th>Target</th>
                                <th>Business Description</th>
                                <th>Financials</th>
                                <th>Revenue_USD_M</th>
                                <th>EBITDA_USD_M</th>
                                <th>Valuation_USD_M</th>
                                <th>Other Info</th>
                                <th>Deal Intelligence info</th>
                                <th>News Date</th>
                                <th>KPMG View - Redacted</th>
                                <th>Credentials</th>
                                <th>HS contact</th>
                                <th>Investment date</th>
                                <th>Geographic region</th>
                                <th>Asset pack</th>
                                <th>Target Region</th>
                                <th>Shareholders</th>
                                <th>Lead type</th>
                                <th>Target HS industry classification</th>
                                <th>Stake for sale_percent</th>
                                <th>Value_USD_M</th>
                                <th>Value description</th>
                                <th>Website</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <!-- Input fields for each column -->
                                <td><input type="number" id="new-num"></td>
                                <td><input type="date" id="new-capturedDate"></td>
                                <td><input type="text" id="new-bpComments"></td>
                                <td><input type="text" id="new-partnerDirector"></td>
                                <td><input type="text" id="new-targetCountry"></td>
                                <td><input type="text" id="new-subSector"></td>
                                <td><input type="text" id="new-source"></td>
                                <td><input type="text" id="new-target"></td>
                                <td><input type="text" id="new-businessDescription"></td>
                                <td><input type="text" id="new-financials"></td>
                                <td><input type="text" id="new-revenueUSD_M"></td>
                                <td><input type="text" id="new-ebitdaUSD_M"></td>
                                <td><input type="text" id="new-valuationUSD_M"></td>
                                <td><input type="text" id="new-otherInfo"></td>
                                <td><input type="text" id="new-dealIntelligenceInfo"></td>
                                <td><input type="date" id="new-newsDate"></td>
                                <td><input type="text" id="new-kpmgViewRedacted"></td>
                                <td><input type="text" id="new-credentials"></td>
                                <td><input type="text" id="new-hsContact"></td>
                                <td><input type="text" id="new-investmentDate"></td>
                                <td><input type="text" id="new-geographicRegion"></td>
                                <td><input type="text" id="new-assetPack"></td>
                                <td><input type="text" id="new-targetRegion"></td>
                                <td><input type="text" id="new-shareholders"></td>
                                <td><input type="text" id="new-leadType"></td>
                                <td><input type="text" id="new-targetHSIndustryClassification"></td>
                                <td><input type="text" id="new-stakeForSalePercent"></td>
                                <td><input type="text" id="new-valueUSD_M"></td>
                                <td><input type="text" id="new-valueDescription"></td>
                                <td><input type="text" id="new-website"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="addRowConfirmButton">Add Row</button>
                </div>
            </div>
        </div>
    </div>

    <div id="slicer-container">
        <!-- Dropdown slicers will be generated here -->
    </div>

    <div class="table-details" style="display: none;">
        <!-- Table Data from BigQuery will be generated here -->
    </div>

    <div class="loading-container">
        <div class="loading-animation"></div>
    </div>

<!-- Add any JavaScript links or scripts here -->
<!-- Add the SheetJS library for Excel file handling -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.4/xlsx.full.min.js"></script>
<!-- Add Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" crossorigin="anonymous"></script>

<!-- Add jQuery for making AJAX requests -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    $(document).ready(function() {
        // Show the loading animation
        $('.loading-container').show();
        displayRollingShortlist();

        function displayRollingShortlist() {
            $.get(`http://127.0.0.1:5004/get_rollingshortlist`, function(data) {
                // Hide the loading animation
                $('.loading-container').hide();
                tableName = "Rolling_Shortlist"

                const columnOrder = [
                "Num",
                "Captured date",
                "BP comments",
                "Partner_or_Director",
                "Target country",
                "Sub sector",
                "Source",
                " Target",
                "Populate Financials?",
                "Business Description",
                "Financials",
                "Revenue_USD_M",
                "EBITDA_USD_M",
                "Valuation_USD_M",
                "Other Info",
                "Deal Intelligence info",
                "News Date",
                "KPMG View - Redacted",
                "Credentials",
                "HS contact",
                "Investment date",
                "Geographic region",
                "Asset pack ",
                "Target Region",
                "Shareholders",
                "Lead type",
                "Target HS industry classification ",
                "Stake for sale_percent",
                "Value_USD_M",
                "Value description ",
                "Website",
                ];

                const tableData = data; // Already parsed JSON

                // Generate a table HTML using the fetched data
                let tableHtml = '<table class="table" id="RS_table">';
                    
                // Generate table headers
                tableHtml += '<thead><tr>';
                for (const columnName of columnOrder) {
                    tableHtml += `
                        <th>${columnName}</th>
                    `;
                    
                }
                tableHtml += '</tr></thead>';

                // For Search text input
                tableHtml += '<thead><tr>';
                for (const columnName of columnOrder) {
                    tableHtml += `
                        <th><input type="text" class="column-search" data-col-name="${columnName}" placeholder="Search ${columnName}"></th>
                    `;
                    
                }
                tableHtml += '</tr></thead>';
                
                // Generate table rows
                tableHtml += '<tbody>';
                for (const opportunityId in tableData) {
                    const row = tableData[opportunityId];
                    tableHtml += '<tr>';
                    for (const columnName of columnOrder) {
                        if (columnName === "Populate Financials?") {
                            // Add a new column with checkboxes
                            tableHtml += '<td data-col-name="Populate Financials?" contenteditable="false"><input type="checkbox" class="populate-financials-checkbox"></td>';
                        } else {
                            const cellContent = row[columnName];
                            if (cellContent !== null) {
                                if (cellContent.length > 30) {
                                    const uniqueID = `modal-${columnName.trim().substring(0, 3)}`;
                                    tableHtml += `
                                        <td data-col-name="${columnName}" data-full-content="${cellContent}">${cellContent.substring(0, 30)}
                                            <span><button class="expand-button" data-bs-toggle="modal" data-bs-target="#${uniqueID}">...</button></span>
                                            <div class="modal fade" id="${uniqueID}" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                                                <div class="modal-dialog modal-dialog-scrollable">
                                                    <div class="modal-content">
                                                        <div class="modal-header">
                                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                        </div>
                                                        <div class="modal-body"></div>
                                                        <div class="modal-footer">
                                                            <button type="button" class="btn btn-secondary close-modal-button" data-bs-dismiss="modal">Close</button>
                                                            <button type="button" id="save-changes" class="btn btn-primary">Save changes</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                        `;
                                } else {
                                    tableHtml += `<td data-col-name="${columnName}" contenteditable="true">${cellContent}</td>`;
                                }
                            } else {
                                tableHtml += `<td data-col-name="${columnName}" contenteditable="true"> </td>`;
                            }
                        }
                    }
                    tableHtml += '</tr>';
                }

                // Add editable attribute to each cell
                tableHtml = tableHtml.replace(/<td>/g, '<td contenteditable="true">');

                // Append table name
                tableNameHtml = `<h4 style='margin-right: 10px;'>${tableName}</h4>`
                $('.table-name').html(tableNameHtml);

                // Append Save Changes button
                saveHtml = '<button id="save-changes" class="btn btn-primary">Save Changes</button>';
                $('.save-button').html(saveHtml);

                // Append Add Row button
                addHtml = '<button id="add-row" class="btn btn-success"><img src="../static/images/plus.png" alt="Add Row" width=25 height=25></button>';
                $('.add-row-button').html(addHtml);

                // Append Financials button
                financialsHtml = '<button id="generate-financials" class="btn btn-info"><img src="../static/images/dollar.png" alt="Generate Financials" width=25 height=25></button>';
                $('.financials-button').html(financialsHtml);

                // Append Generate Asset Pack button
                generateHtml = '<button id="generate-assetpack" class="btn" style="background-color: #9900ffff; color: white;">Generate Asset Pack</button>';
                $('.generate-assetpack-button').html(generateHtml);

                // Update the table details placeholder and show it
                $('.table-details').html(tableHtml).show();

                // Hide the tile container
                $('.tile-container').hide();

                // Generate dropdown slicers for each column
                const slicerContainer = document.getElementById("slicer-container");

                slicerHTML = `
                <div class="container">
                    <div class="row">
                `;

                for (const columnName of columnOrder) {
                    if (["BP comments", "Geographic region", "Target Region", "Target country", "Source", "Target HS industry classification ", "Lead type", "Credentials"].includes(columnName)) {
                        const uniqueValues = [...new Set(tableData.map(row => row[columnName]))];

                        slicerHTML += `
                        <div class="col-md-3">
                            <div class="slicer-container">
                                <div class="slicer">
                                    <div class="slicer-header">${columnName}</div>
                                    <div class="slicer-options">
                        `

                        for (const value of uniqueValues) {
                            slicerHTML += `
                                <label><input type="checkbox" class="slicer-checkbox" value="${value}">${value}</label>
                            `
                        }

                        slicerHTML += `
                                    </div>
                                </div>
                            </div>
                        </div>
                        `
                    }
                }

                slicerHTML += `
                    </div>
                </div>
                `

                slicerContainer.innerHTML = slicerHTML;

                function applyColumnSearch() {
                    $('.column-search').on('input', function () {
                        // Get all search values from all search inputs
                        const searchValues = {};
                        $('.column-search').each(function () {
                            const columnName = $(this).data('col-name');
                            const searchText = $(this).val().toLowerCase();
                            searchValues[columnName] = searchText;
                        });

                        $('.table tbody tr').each(function () {
                            let rowVisible = true;
                            const $row = $(this);

                            // Check if any search text matches in any of the columns
                            for (const columnName of columnOrder) {
                                const cellText = $row.find(`td[data-col-name="${columnName}"]`).text().toLowerCase();
                                const searchText = searchValues[columnName];
                                if (searchText && !cellText.includes(searchText)) {
                                    rowVisible = false;
                                    break;
                                }
                            }

                            // Toggle row visibility
                            if (rowVisible) {
                                $row.show();
                            } else {
                                $row.hide();
                            }
                        });
                    });
                }

                function applySlicerFiltering() {
                    $('.slicer-container').on('input', 'input[type="checkbox"]', function () {
                        // Get all selected slicer values and their corresponding column names
                        const selectedSlicerValues = {};
                        $('.slicer-container').each(function () {
                            const slicerHeading = $(this).find('.slicer-header').text().trim();
                            const selectedValues = [];
                            $(this).find('input[type="checkbox"]:checked').each(function () {
                                selectedValues.push($(this).val());
                            });
                            if (selectedValues.length > 0) {
                                selectedSlicerValues[slicerHeading] = selectedValues;
                                console.log(slicerHeading + ": " + selectedValues);
                            }
                        });

                        // Hide or show table rows based on selected slicer values
                        $('.table tbody tr').each(function () {
                            let rowVisible = true;
                            const $row = $(this);

                            // Check if all selected slicer values match in their respective columns
                            for (const slicerHeading in selectedSlicerValues) {
                                const columnIndex = columnOrder.indexOf(slicerHeading);

                                if (columnIndex !== -1) {
                                    const cellText = $row.find(`td:eq(${columnIndex})`).text().toLowerCase();
                                    const selectedValues = selectedSlicerValues[slicerHeading];
                                    let matchesAllValues = true;

                                    for (const value of selectedValues) {
                                        if (!cellText.includes(value.toLowerCase())) {
                                            matchesAllValues = false;
                                            break;
                                        }
                                    }

                                    if (!matchesAllValues) {
                                        rowVisible = false;
                                        break; // No need to check further
                                    }
                                }
                            }

                            // Toggle row visibility
                            if (rowVisible) {
                                $row.show();
                            } else {
                                $row.hide();
                            }
                        });
                    });
                }

                applyColumnSearch();
                applySlicerFiltering();
                console.log("display successful");

                // Create a button element
                const downloadButton = document.createElement('button');
                downloadButton.id = 'download-button';
                downloadButton.className = 'btn btn-warning';

                // Create an image element for the button
                const downloadImage = document.createElement('img');
                downloadImage.src = '../static/images/download_icon.png'; // Set the image source
                downloadImage.alt = 'Download Table'; // Set alt text for accessibility
                downloadImage.width = 20; // Set the width
                downloadImage.height = 20; // Set the height

                downloadButton.appendChild(downloadImage); // Append the image to the button

                downloadButton.addEventListener('click', async () => {
                    const response = await fetch('http://127.0.0.1:5004/download_rollingshortlist');
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'Rolling Shortlist.xlsx';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                });

                // Append the button to the button container
                const buttonContainer = document.querySelector('.button-container');
                buttonContainer.appendChild(downloadButton);
            });
        }


        // Function specifically for Rolling Shortlist table
        function updateRollingShortlist() {
            const editedCells = $('.table td.editing'); // Get all edited cells
            const editedModal = $('.modal-body.editing'); // Get the edited cell inside the modal

            let showAlert = true; // Initialize the showAlert flag as true

            const updatedRows = [];

            if (editedCells.length > 0) {
                showAlert = false;

                editedCells.each(function () {
                const editedCell = $(this);
                const Num = editedCell.closest('tr').find('td:nth-child(1)').text(); // 1st column is Num (unique row number)
                const columnName = editedCell.data('col-name');
                const cellValue = editedCell.text();

                console.log(Num);
                console.log(columnName);
                console.log(cellValue);

                    updatedRows.push({
                        row_id: Num,
                        column_name: columnName,
                        edited_value: cellValue
                    });
                });
            }

            if (editedModal.length > 0) {
                // Get the updated content from the modal and update the corresponding cell
                const modalId = editedModal.closest('.modal').attr('id'); // Get the modal ID
                const editedContent = $(`#${modalId} .modal-body`).text(); // Get the content from the modal

                const Num = editedModal.closest('tr').find('td:nth-child(1)').text(); // 1st column is Num
                const columnName = editedModal.closest('.table td').data('col-name');

                updatedRows.push({
                    row_id: Num,
                    column_name: columnName,
                    edited_value: editedContent
                });

                showAlert = false; // Modal is edited, so do not show the alert
            }

            console.log(updatedRows);

            if (showAlert) {
                alert("No cell is being edited.");
                return;
            }

            // Send the updated data to the backend using fetch
            fetch('http://127.0.0.1:5004/update_rollingshortlist', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updatedRows)
            })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error("An error occurred while saving changes.");
                    }
                })
                .then(data => {
                    console.log(data);
                    if (data.success) {
                        console.log("edit successful!");
                        alert("Edit successful!");

                        setTimeout(function(){
                            window.location.reload();
                        }, 10000); // Reload the table after a successful update
                    } else {
                        displayRollingShortlist();
                        displayErrorMessage("An error occurred while saving changes.");
                    }
                })
                .catch(error => {
                    console.error(error);
                    displayRollingShortlist();
                    displayErrorMessage("An error occurred while saving changes.");
                });
        }

        // Click event handler for the "Add Row" button
        $('.add-row-button').click(function() {
            $('#addRowModal').modal('show');
        });

        // Click event handler for the "Add Row" modal's "Add Row" button
        $('#addRowConfirmButton').click(function() {
            // Collect data from input fields
            const newRowData = {
                Num: parseFloat($('#new-num').val()) || 0, // Use 0 as a default value if not provided
                Captured_date: parseFloat($('#new-capturedDate').val()) || parseFloat(new Date().getTime()), // Use current timestamp if not provided
                BP_comments: $('#new-bpComments').val() || " ",
                Partner_or_Director: $('#new-partnerDirector').val() || " ",
                Target_country: $('#new-targetCountry').val() || " ",
                Sub_sector: $('#new-subSector').val() || " ",
                Source: $('#new-source').val() || " ",
                Target: $('#new-target').val() || " ",
                Business_Description: $('#new-businessDescription').val() || " ",
                Financials: $('#new-financials').val() || " ",
                Revenue_USD_M: $('#new-revenueUSD_M').val() || " ",
                EBITDA_USD_M: $('#new-ebitdaUSD_M').val() || " ",
                Valuation_USD_M: $('#new-valuationUSD_M').val() || " ",
                Other_Info: $('#new-otherInfo').val() || " ",
                Deal_Intelligence_info: $('#new-dealIntelligenceInfo').val() || " ",
                News_Date: parseFloat($('#new-newsDate').val()) || parseFloat(new Date().getTime()), // Use current timestamp if not provided
                KPMG_View_Redacted: $('#new-kpmgViewRedacted').val() || " ",
                Credentials: $('#new-credentials').val() || " ",
                HS_contact: $('#new-hsContact').val() || " ",
                Investment_date: $('#new-investmentDate').val() || " ",
                Geographic_region: $('#new-geographicRegion').val() || " ",
                Asset_pack: $('#new-assetPack').val() || " ",
                Target_Region: $('#new-targetRegion').val() || " ",
                Shareholders: $('#new-shareholders').val() || " ",
                Lead_type: $('#new-leadType').val() || " ",
                Target_HS_industry_classification: $('#new-targetHSIndustryClassification').val() || " ",
                Stake_for_sale_percent: $('#new-stakeForSalePercent').val() || " ",
                Value_USD_M: $('#new-valueUSD_M').val() || "",
                Value_description: $('#new-valueDescription').val() || " ",
                Website: $('#new-website').val() || " ",
            };

            // Send the new row data to the server
            $.ajax({
                url: 'http://127.0.0.1:5004/add_rollingshortlist_row',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(newRowData),
                success: function(response) {
                    if (response.success) {
                        alert('Row added successfully.');
                        // Refresh the table after adding the row
                        setTimeout(function(){
                            window.location.reload();
                        }, 10000); // Reload the table after a successful update
                    } else {
                        alert('Error adding row.');
                    }
                    $('#addRowModal').modal('hide');
                },
                error: function() {
                    alert('Error adding row.');
                    $('#addRowModal').modal('hide');
                }
            });
        });

        
        $(document).on('click', '.expand-button', function () {
            const modalId = $(this).data('bs-target'); // Get the modal's target ID
            const cellContent = $(this).closest('td').data('full-content');
            console.log(cellContent);

            // Find the modal using its unique ID and show it
            $(modalId).find('.modal-body').html(`<div contenteditable="true">${cellContent}</div>`);

            // Add the "editing" class to the cell
            $(modalId).find('.modal-body').addClass('editing');
            
            if (!$(this).closest('td').hasClass('expanded')) {
                // Add the "expanded" class to the cell if it's not already expanded
                $(this).closest('td').addClass('expanded');
            } else {
                // Remove the "expanded" class if it's already expanded (e.g., when closing the modal)
                $(this).closest('td').removeClass('expanded');
            }
            
            $(modalId).modal('show');
        });

        // Initialize an array to keep track of editing cells
        const editingCells = [];

        // Click event handler for cells with contenteditable="true"
        $(document).on('click', '.table td[contenteditable="true"]', function() {
            console.log("This cell is being edited!");
            $(this).addClass('editing');
            // Add the cell to the editingCells array
            editingCells.push(this);
        });

        // Click event handler for #save-changes button
        $(document).on('click', '#save-changes', function() {
            const tableName = $('.table-name').text();
            updateRollingShortlist();

            // Remove the "editing" and "expanded" classes from all cells in the editingCells array
            editingCells.forEach(function (cell) {
                $(cell).removeClass('editing expanded');
            });

            // Clear the editingCells array
            editingCells.length = 0;
        });

        // Add an event listener to the "Generate Asset Pack" button
        $('.generate-assetpack-button').on('click', function() {
            // Show the Generate Asset Pack modal
            $('#generateAPModal').modal('show');
        });

        // Add an event listener to the "Generate" button in the modal
        $('#generateAssetPackButton').on('click', function() {
            // Get the entered target name from the input field
            const enteredTargetName = $('#targetNameInput').val();

            // Check if the entered target name is valid
            const isValidTarget = isTargetValid(enteredTargetName);

            if (isValidTarget) {
                // Valid target name, add your logic for generating Asset Pack here
                // This function will be executed when the "Generate" button is clicked in the modal.
                
                // Hide validation error message
                $('#validationError').hide();

                // Display the confirmation message
                const confirmed = confirm(`You are going to generate an Asset Pack for ${enteredTargetName}`);

                if (confirmed) {
                    // Close the Individual modal
                    $('#generateAPModal').modal('hide');
                }
            } else {
                // Display validation error message
                $('#validationError').show();
            }
        });

        // Function to check if the entered target name is valid
        function isTargetValid(targetName) {
            // Iterate through the values in the "Target" column of the table
            const targetColumnValues = $('#RS_table tbody td[data-col-name=" Target"]').map(function() {
                return $(this).text().trim();
            }).get();

            // Check if the entered target name exists in the "Target" column values
            return targetColumnValues.includes(targetName);
        }


        // FOR SCRAPING

        // Function to update the selected count based on checked checkboxes
        function updateSelectedCount() {
            const checkedCheckboxes = $('#RS_table tbody td[data-col-name="Populate Financials?"] input:checked');
            const selectedCount = checkedCheckboxes.length;
            const selectedTargets = checkedCheckboxes.map(function () {
                const cell = $(this).closest('tr').find('td[data-col-name=" Target"]');
                const cellContent = cell.text().trim();
                
                // Check if the cell has a data-full-content attribute
                const fullContentAttr = cell.attr('data-full-content');
                if (fullContentAttr) {
                    // Use the data-full-content attribute value
                    return fullContentAttr.trim();
                } else {
                    return cellContent;
                }
            }).get();

            // Update the selected count
            $('#selectedCount').text(selectedCount);

            // Update the list of selected Target names
            const targetList = $('#selectedTargets');
            targetList.empty(); // Clear the list
            if (selectedTargets.length > 0) {
                selectedTargets.forEach(function (target) {
                    const listItem = $('<li></li>').text(target);
                    targetList.append(listItem);
                });
            }
        }

        // Button click event to open the initial modal
        $('.financials-button').click(function () {
            updateSelectedCount(); // Update the selected count
            $('#financialsModal').modal('show'); // Show the initial modal
        });

        // Proceed button click event in the initial modal
        $('#proceedAll').click(function () {
            // Handle the "Proceed" action for all selected financials
            // You can implement your logic here
        });

        // Individual Scraping button click event in the initial modal
        $('#individualScraping').click(function () {
            // Close the initial modal
            $('#financialsModal').modal('hide');

            // Show the second modal for individual scraping
            $('#individualModal').modal('show');
        });

        // Proceed button click event in the initial modal
        $('#proceedIndividual').click(function () {
            // Handle the "Proceed with Scraping" action for individual Target
            // Get the entered target name from the input field
            const enteredNum = $('#numInput').val();

            // Check if the entered target name is valid
            const isValidNum = isNumValid(enteredNum);

            if (isValidNum) {
                // Hide validation error message
                $('#NumvalidationError').hide();

                // Find the index of the entered Num in the "Num" column values
                const rowIndex = $('#RS_table tbody td[data-col-name="Num"]').filter(function() {
                    return $(this).text().trim() === enteredNum.toString();
                }).closest('tr').index();

                // Get the Target's name from the same row
                const targetName = $('#RS_table tbody tr').eq(rowIndex).find('td[data-col-name=" Target"]').text().trim();

                // Display the confirmation message
                const confirmed = confirm(`You are going to populate financials for ${targetName}`);

                if (confirmed) {
                    // Close the Individual modal
                    $('#individualModal').modal('hide');
                }
            } else {
                // Display validation error message
                $('#NumvalidationError').show();
            }
        });

        // Function to check if the entered Num is valid
        function isNumValid(Num) {
            // Iterate through the values in the "Num" column of the table
            const NumColumnValues = $('#RS_table tbody td[data-col-name="Num"]').map(function() {
                return $(this).text().trim();
            }).get();

            // Check if the entered Num exists in the "Num" column values
            return NumColumnValues.includes(Num.toString());
        }

        // Scrape ALL button click event in the initial modal
        $('#scrapeAll').click(function () {
            // Display a confirmation dialog
            const confirmed = confirm("Are you sure you want to scrape ALL financials?");
            
            // Check if the user confirmed
            if (confirmed) {
                 // Close the initial modal
                $('#financialsModal').modal('hide');
                // Perform the "Scrape ALL" action
                // You can implement your logic here

                // For example, you can call a function to initiate the scraping
                // scrapeAllFinancials();
            }
        });
    });
</script>
</body>
</html>
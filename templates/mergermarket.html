<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Previewing tables</title>
    <!-- Add Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f0f0;
        }

        .navbar {
            position: sticky;
            background-color: #f8f9fa;
            border-bottom: 1px solid #ddd;
            position: sticky;
            top: 0;
            z-index: 1000; /* Ensure Navbar is above other content */
        }

        .navbar-nav {
            margin-right: auto;
        }

        /* Add this CSS to style the displayed table */
        .table {
            width: 100%;
            border-collapse: collapse;
            position: relative;
        }

        .table th,
        .table td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }

        .table td {
            white-space: normal;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .table th {
            position: sticky;
            top: 0px; /* 63px for below navbar */
            background-color: #dbdbdb; /* Set the background color */
            color: black; /* Set the text color */
            z-index: 1001;
        }

        /* Add this CSS to adjust the layout when table is displayed */
        .table-details {
            max-width: 800px;
            padding: 0;
        }

        /* Add this CSS to change cell color when editing starts */
        .table td[contenteditable="true"]:focus {
            background-color: orange;
        }
        .table td.expanded div[contenteditable="true"]:focus {
            background-color: orange;
            padding: 8px;
            margin: -8px; /* Counteract padding to maintain cell size */
            border: 1px solid #ccc;
            white-space: normal;
            overflow: visible;
        }
        .table td.expanded {
            background-color: orange;
        }
        .table td.editing {
            background-color: orange;
        }

        .button-container {
            display: flex; /* Use flexbox to align buttons horizontally */
            align-items: center; /* Center items vertically within the container */
            margin-top: 10px; /* Adjust margin as needed */
        }

        .save-button,
        .add-row-button,
        .populate-MS-button {
            margin-right: 10px; /* Add space between buttons */
        }

        /* Add this CSS to style the "Expand" button */
        .expand-button {
            border-radius: 10px;
            border: none;
            display: inline-block;
            cursor: pointer;
        }

        /* Style the column search input boxes */
        .column-search {
            width: 100%;
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        /* for loading animation */
        .loading-container {
            display: flex;
            justify-content: center;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8); /* Semi-transparent background */
            z-index: 9999; /* Higher z-index to cover the entire page */
        }


        .loading-animation {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <!-- Back Button -->
            <a class="navbar-brand" href="/preview">
                <img src="../static/images/left-arrow.png" alt="Back" width="30" height="30">
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Upload</a>
                    </li>
                    <li class="nav-item active">
                        <a class="nav-link" href="/model_testing">Model Testing</a>
                    </li>
                    <li class="nav-item active">
                        <a class="nav-link" href="/preview">Preview Tables</a>
                    </li>
                </ul>
            </div>

            <div class="button-container">
                <div class="table-name"></div>
                <div class="populate-MS-button"></div>
                <div class="add-row-button"></div>
                <div class="save-button"></div>
            </div>
        </div>
    </nav>

    <!-- Modal for confirmation of populating Market Scan -->
    <div class="modal fade" id="populateMSModal" tabindex="-2" aria-labelledby="populateMSModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="populateMSModalLabel">Populate Market Scan</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="max-height: 400px; overflow-y: auto;">
                    
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="populateMSModalConfirm">Populate</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add a modal for adding a new row -->
    <div class="modal fade" id="addRowModal" tabindex="-1" aria-labelledby="addRowModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addRowModalLabel">Add Row</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="max-height: 400px; overflow-y: auto;">
                    <table class="table">
                        <thead>
                            <tr>
                                <!-- Header columns based on your BigQuery table headers -->
                                <th>Opportunity_ID</th>
                                <th>Date</th>
                                <th>Value INR_m</th>
                                <th>Value Description</th>
                                <th>Heading</th>
                                <th>Opportunity</th>
                                <th>Targets</th>
                                <th>Lead type</th>
                                <th>Type of transaction</th>
                                <th>HS sector classification</th>
                                <th>Short BD</th>
                                <th>Source</th>
                                <th>Intelligence Type</th>
                                <th>Intelligence Grade</th>
                                <th>Intelligence Size</th>
                                <th>Stake Value</th>
                                <th>Dominant Sector</th>
                                <th>Sectors</th>
                                <th>Sub Sectors</th>
                                <th>Dominant Geography</th>
                                <th>Geography</th>
                                <th>States</th>
                                <th>Topics</th>
                                <th>Bidders</th>
                                <th>Vendors</th>
                                <th>Issuers</th>
                                <th>Competitors</th>
                                <th>Others</th>
                                <th>Completed</th>
                                <!-- Add other header columns here -->
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <!-- Input fields for each column -->
                                <td><input type="number" id="new-opportunityId"></td>
                                <td><input type="date" id="new-date"></td>
                                <td><input type="text" id="new-INRm"></td>
                                <td><input type="text" id="new-valueDesc"></td>
                                <td><input type="text" id="new-heading"></td>
                                <td><input type="text" id="new-opportunity"></td>
                                <td><input type="text" id="new-targets"></td>
                                <td><input type="text" id="new-leadtype"></td>
                                <td><input type="text" id="new-typetrans"></td>
                                <td><input type="text" id="new-hssector"></td>
                                <td><input type="text" id="new-shortbd"></td>
                                <td><input type="text" id="new-source"></td>
                                <td><input type="text" id="new-inteltype"></td>
                                <td><input type="text" id="new-intelgrade"></td>
                                <td><input type="text" id="new-intelsize"></td>
                                <td><input type="text" id="new-stakevalue"></td>
                                <td><input type="text" id="new-domsect"></td>
                                <td><input type="text" id="new-sect"></td>
                                <td><input type="text" id="new-subsect"></td>
                                <td><input type="text" id="new-domgeog"></td>
                                <td><input type="text" id="new-geog"></td>
                                <td><input type="text" id="new-states"></td>
                                <td><input type="text" id="new-topics"></td>
                                <td><input type="text" id="new-bidders"></td>
                                <td><input type="text" id="new-vendors"></td>
                                <td><input type="text" id="new-issuers"></td>
                                <td><input type="text" id="new-competitors"></td>
                                <td><input type="text" id="new-others"></td>
                                <td><input type="text" id="new-completed"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="addRowConfirmButton">Add Row</button>
                </div>
            </div>
        </div>
    </div>

    <div class="table-details" style="display: none;">
        <!-- Table Data from BigQuery will be generated here -->
    </div>

    <div class="loading-container">
        <div class="loading-animation"></div>
    </div>

<!-- Add any JavaScript links or scripts here -->
<!-- Add the SheetJS library for Excel file handling -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.4/xlsx.full.min.js"></script>
<!-- Add Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" crossorigin="anonymous"></script>

<!-- Add jQuery for making AJAX requests -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    $(document).ready(function() {
        // Show the loading animation
        $('.loading-container').show();
        displayMergerMarket();

        // To display MergerMarket table
        function displayMergerMarket() {
            $.get(`http://127.0.0.1:5003/get_mergermarket`, function(data) {
                // Hide the loading animation
                $('.loading-container').hide();
                tableName = "MergerMarket"

                const columnOrder = [
                    "Opportunity_ID",
                    "Date",
                    "Value INR_m",
                    "Value Description",
                    "Heading",
                    "Opportunity",
                    "Targets",
                    "Lead type",
                    "Type of transaction",
                    "HS sector classification",
                    "Short BD",
                    "Source",
                    "Intelligence Type",
                    "Intelligence Grade",
                    "Intelligence Size",
                    "Stake Value",
                    "Dominant Sector",
                    "Sectors",
                    "Sub Sectors",
                    "Dominant Geography",
                    "Geography",
                    "States",
                    "Topics",
                    "Bidders",
                    "Vendors",
                    "Issuers",
                    "Competitors",
                    "Others",
                    "Completed"
                ];

                const tableData = data; // Already parsed JSON

                // Generate a table HTML using the fetched data
                let tableHtml = '<table class="table" id="MM_table">';
                    
                // Generate table headers
                tableHtml += '<thead><tr>';
                for (const columnName of columnOrder) {
                    tableHtml += `<th>${columnName}</th>`;
                }
                tableHtml += '</tr></thead>';

                // For Search text input
                tableHtml += '<thead><tr>';
                for (const columnName of columnOrder) {
                    tableHtml += `
                        <th><input type="text" class="column-search" data-col-name="${columnName}" placeholder="Search ${columnName}"></th>
                    `;
                    
                }
                tableHtml += '</tr></thead>';
                
                // Generate table rows
                tableHtml += '<tbody>';
                for (const opportunityId in tableData) {
                    const row = tableData[opportunityId];
                    tableHtml += '<tr>';
                    for (const columnName of columnOrder) {
                        const cellContent = row[columnName];
                        if (cellContent !== null) {
                            if (cellContent.length > 30) {
                                const uniqueID = `modal-${columnName.substring(0, 3)}`;
                                tableHtml += `
                                    <td data-col-name="${columnName}" data-full-content="${cellContent}">${cellContent.substring(0, 30)}
                                        <span><button class="expand-button" data-bs-toggle="modal" data-bs-target="#${uniqueID}">...</button></span>
                                        <div class="modal fade" id="${uniqueID}" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                                            <div class="modal-dialog modal-dialog-scrollable">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                    </div>
                                                    <div class="modal-body"></div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary close-modal-button" data-bs-dismiss="modal">Close</button>
                                                        <button type="button" id="save-changes" class="btn btn-primary">Save changes</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                    `;
                            } else {
                                tableHtml += `<td data-col-name="${columnName}" contenteditable="true">${cellContent}</td>`;
                            }
                        } else {
                            tableHtml += `<td data-col-name="${columnName}" contenteditable="true"> </td>`;
                        }
                    }
                    tableHtml += '</tr>';
                }

                // Add editable attribute to each cell
                tableHtml = tableHtml.replace(/<td>/g, '<td contenteditable="true">');

                // Append table name
                tableNameHtml = `<h4 style='margin-right: 10px;'>${tableName}</h4>`
                $('.table-name').html(tableNameHtml);

                // Append Save Changes button
                saveHtml = '<button id="save-changes" class="btn btn-primary">Save Changes</button>';
                $('.save-button').html(saveHtml);

                // Append Add Row button
                addHtml = '<button id="add-row" class="btn btn-success">Add Row</button>';
                $('.add-row-button').html(addHtml);

                // Append Populate Market Scan button
                populateHtml = '<button id="populate-MS" class="btn" style="background-color: #9900ffff; color: white;">Populate MS</button>';
                $('.populate-MS-button').html(populateHtml);

                // Update the table details placeholder and show it
                $('.table-details').html(tableHtml).show();

                // Hide the tile container
                $('.tile-container').hide();

                // For Search Function
                function applyColumnSearch() {
                    $('.column-search').on('input', function () {
                        // Get all search values from all search inputs
                        const searchValues = {};
                        $('.column-search').each(function () {
                            const columnName = $(this).data('col-name');
                            const searchText = $(this).val().toLowerCase();
                            searchValues[columnName] = searchText;
                        });

                        $('.table tbody tr').each(function () {
                            let rowVisible = true;
                            const $row = $(this);

                            // Check if any search text matches in any of the columns
                            for (const columnName of columnOrder) {
                                const cellText = $row.find(`td[data-col-name="${columnName}"]`).text().toLowerCase();
                                const searchText = searchValues[columnName];
                                if (searchText && !cellText.includes(searchText)) {
                                    rowVisible = false;
                                    break;
                                }
                            }

                            // Toggle row visibility
                            if (rowVisible) {
                                $row.show();
                            } else {
                                $row.hide();
                            }
                        });
                    });
                }

                applyColumnSearch();
                console.log("display successful");

                // Create a button element
                const downloadButton = document.createElement('button');
                downloadButton.id = 'download-button';
                downloadButton.className = 'btn btn-warning';

                // Create an image element for the button
                const downloadImage = document.createElement('img');
                downloadImage.src = '../static/images/download_icon.png'; // Set the image source
                downloadImage.alt = 'Download Table'; // Set alt text for accessibility
                downloadImage.width = 20; // Set the width
                downloadImage.height = 20; // Set the height

                downloadButton.appendChild(downloadImage); // Append the image to the button

                downloadButton.addEventListener('click', async () => {
                    const response = await fetch('http://127.0.0.1:5003/download_mergermarket');
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'MergerMarket.xlsx';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                });

                // Append the button to the button container
                const buttonContainer = document.querySelector('.button-container');
                buttonContainer.appendChild(downloadButton);
            });
        }

        // Function specifically for MergerMarket table
        function updateMergerMarket() {
            const editedCells = $('.table td.editing'); // Get all edited cells
            const editedModal = $('.modal-body.editing'); // Get the edited cell inside the modal

            let showAlert = true; // Initialize the showAlert flag as true

            const updatedRows = [];

            if (editedCells.length > 0) {
                showAlert = false;

                editedCells.each(function () {
                const editedCell = $(this);
                const opportunityId = editedCell.closest('tr').find('td:nth-child(1)').text(); // 1st column is Opportunity_ID (unique row number)
                const columnName = editedCell.data('col-name');
                const cellValue = editedCell.text();

                console.log(opportunityId);
                console.log(columnName);
                console.log(cellValue);

                    updatedRows.push({
                        row_id: opportunityId,
                        column_name: columnName,
                        edited_value: cellValue
                    });
                });
            }

            if (editedModal.length > 0) {
                // Get the updated content from the modal and update the corresponding cell
                const modalId = editedModal.closest('.modal').attr('id'); // Get the modal ID
                const editedContent = $(`#${modalId} .modal-body`).text(); // Get the content from the modal

                const opportunityId = editedModal.closest('tr').find('td:nth-child(1)').text(); // 1st column is Opportunity_ID
                const columnName = editedModal.closest('.table td').data('col-name');

                updatedRows.push({
                    row_id: opportunityId,
                    column_name: columnName,
                    edited_value: editedContent
                });

                showAlert = false; // Modal is edited, so do not show the alert
            }

            console.log(updatedRows);

            if (showAlert) {
                alert("No cell is being edited.");
                return;
            }

            // Send the updated data to the backend using fetch
            fetch('http://127.0.0.1:5003/update_mergermarket', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updatedRows)
            })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error("An error occurred while saving changes.");
                    }
                })
                .then(data => {
                    console.log(data);
                    if (data.success) {
                        console.log("edit successful!");
                        alert("Edit successful!");

                        setTimeout(function(){
                            window.location.reload();
                        }, 5000); // Reload the table after a successful update
                    } else {
                        displayMergerMarket();
                        displayErrorMessage("An error occurred while saving changes.");
                    }
                })
                .catch(error => {
                    console.error(error);
                    displayMergerMarket();
                    displayErrorMessage("An error occurred while saving changes.");
                });
        }

        // Click event handler for the "Add Row" button
        $('.add-row-button').click(function() {
            $('#addRowModal').modal('show');
        });

        // Click event handler for the "Add Row" modal's "Add Row" button
        $('#addRowConfirmButton').click(function() {
            // Collect data from input fields
            const newRowData = {
                Opportunity_ID: parseFloat($('#new-opportunityId').val()) || 0, // Use 0 as a default value if not provided
                Date: $('#new-date').val() || new Date().toISOString().slice(0, 10), // Use the current date if not provided
                Value_INR_m: $('#new-INRm').val() || " ",
                Value_Description: $('#new-valueDesc').val() || " ",
                Heading: $('#new-heading').val() || " ",
                Opportunity: $('#new-opportunity').val() || " ",
                Targets: $('#new-targets').val() || " ",
                Lead_Type: $('#new-leadtype').val() || " ",
                Type_of_transaction: $('#new-typetrans').val() || " ",
                HS_sector_classification: $('#new-hssector').val() || " ",
                Short_BD: $('#new-shortbd').val() || " ",
                Source: $('#new-source').val() || " ",
                Intelligence_Type: $('#new-inteltype').val() || " ",
                Intelligence_Grade: $('#new-intelgrade').val() || " ",
                Intelligence_Size: $('#new-intelsize').val() || " ",
                Stake_Value: $('#new-stakevalue').val() || " ",
                Dominant_Sector: $('#new-domsect').val() || " ",
                Sectors: $('#new-sect').val() || " ",
                Sub_Sectors: $('#new-subsect').val() || " ",
                Dominant_Geography: $('#new-domgeog').val() || " ",
                Geography: $('#new-geog').val() || " ",
                States: $('#new-states').val() || " ",
                Topics: $('#new-topics').val() || " ",
                Bidders: $('#new-bidders').val() || " ",
                Vendors: $('#new-vendors').val() || " ",
                Issuers: $('#new-issuers').val() || " ",
                Competitors: $('#new-competitors').val() || " ",
                Others: $('#new-others').val() || " ",
                Completed: $('#new-completed').val() || " ",
            };

            // Send the new row data to the server
            $.ajax({
                url: 'http://127.0.0.1:5003/add_mergermarket_row',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(newRowData),
                success: function(response) {
                    if (response.success) {
                        alert('Row added successfully.');
                        // Refresh the table after adding the row
                        setTimeout(function(){
                            window.location.reload();
                        }, 5000); // Reload the table after a successful update
                    } else {
                        alert('Error adding row.');
                    }
                    $('#addRowModal').modal('hide');
                },
                error: function() {
                    alert('Error adding row.');
                    $('#addRowModal').modal('hide');
                }
            });
        });

        
        $(document).on('click', '.expand-button', function () {
            const modalId = $(this).data('bs-target'); // Get the modal's target ID
            const cellContent = $(this).closest('td').data('full-content');
            console.log(cellContent);

            // Find the modal using its unique ID and show it
            $(modalId).find('.modal-body').html(`<div contenteditable="true">${cellContent}</div>`);

            // Add the "editing" class to the cell
            $(modalId).find('.modal-body').addClass('editing');
            
            if (!$(this).closest('td').hasClass('expanded')) {
                // Add the "expanded" class to the cell if it's not already expanded
                $(this).closest('td').addClass('expanded');
            } else {
                // Remove the "expanded" class if it's already expanded (e.g., when closing the modal)
                $(this).closest('td').removeClass('expanded');
            }
            
            $(modalId).modal('show');
        });

        // Initialize an array to keep track of editing cells
        const editingCells = [];

        // Click event handler for cells with contenteditable="true"
        $(document).on('click', '.table td[contenteditable="true"]', function() {
            console.log("This cell is being edited!");
            $(this).addClass('editing');
            // Add the cell to the editingCells array
            editingCells.push(this);
        });

        // Click event handler for #save-changes button
        $(document).on('click', '#save-changes', function() {
            const tableName = $('.table-name').text();
            updateMergerMarket();

            // Remove the "editing" and "expanded" classes from all cells in the editingCells array
            editingCells.forEach(function (cell) {
                $(cell).removeClass('editing expanded');
            });

            // Clear the editingCells array
            editingCells.length = 0;
        });

        // Add an event listener to the "Populate MS" button
        $('.populate-MS-button').on('click', function() {
            console.log("populate being pressed");
            // Calculate the number of rows in the table
            const numRows = $('#MM_table tbody tr').length;

            // Retrieve the first and last Opportunity_ID values
            const firstOpportunityId = $('#MM_table tbody tr:first td[data-col-name="Opportunity_ID"]').text();
            const lastOpportunityId = $('#MM_table tbody tr:last td[data-col-name="Opportunity_ID"]').text();

            // Create the modal content
            const modalContent = `
                You are currently going to populate Market Scan with ${numRows} rows, from Opportunity_ID ${firstOpportunityId} to Opportunity_ID ${lastOpportunityId}.
            `;

            // Update the modal body with the content
            $('.modal-body').html(modalContent);

            // Show the confirmation modal
            $('#populateMSModal').modal('show');
        });

        // ... (other code)

        // Add an event listener to the "Populate" button in the confirmation modal
        $('#populateMSModalConfirm').on('click', function() {
            // Add logic for populating Market Scan here
            // This function will be executed when the "Populate" button is clicked in the modal.
            
            // Close the confirmation modal
            $('#populateMSModal').modal('hide');
        });
    });
</script>
</body>
</html>
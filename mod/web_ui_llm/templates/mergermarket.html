<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Previewing tables</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha384-40oGde+Ap3X0GkgX/xH9EP0F4XsWID3vbS2w3y8k5iKXg8w+2W6JzoF5oj8fH5ZC2" crossorigin="anonymous">
    <style>
        * {
            font-size: 10px;
        }
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f0f0;
        }

        .navbar {
            position: sticky; /* sticky to the top of the page */
            background-color: #6a6a6a;
            border-bottom: 1px solid #ddd;
            position: sticky;
            top: 0;
            z-index: 1000; /* Ensure Navbar is above other content */
        }
        .navbar-nav {
            margin-right: auto;
        }

        /* Styling the table displayed on the frontend */
        .table {
            width: 100%;
            border-collapse: collapse;
            position: relative;
        }
        .table th,
        .table td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }
        .table td {
            white-space: normal;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .table th {
            position: sticky;
            top: 0px; /* 63px for below navbar */
            background-color: #dbdbdb;
            color: black;
            z-index: 1001;
        }
        .table-details {
            max-width: 800px;
            padding: 0;
        }
        /* CSS to change cell color when editing starts */
        .table td[contenteditable="true"]:focus {
            background-color: orange;
        }
        .table td.expanded div[contenteditable="true"]:focus {
            background-color: orange;
            padding: 8px;
            margin: -8px; /* Counteract padding to maintain cell size */
            border: 1px solid #ccc;
            white-space: normal;
            overflow: visible;
        }
        .table td.expanded {
            background-color: orange;
        }
        .table td.editing {
            background-color: orange;
        }

        /* CSS to style the button container and buttons */
        .button-container {
            display: flex; /* Use flexbox to align buttons horizontally */
            align-items: center; /* Center items vertically within the container */
        }
        .save-button,
        .add-row-button,
        .populate-MS-button,
        .LLM-button {
            margin-right: 10px; /* Add space between buttons */
        }
        .expand-button {
            border-radius: 10px;
            border: none;
            display: inline-block;
            cursor: pointer;
        }

        /* for SLICER CONTAINER */
        #slicer-container {
            white-space: nowrap;
        }
        .slicer-container {
            display: inline-block;
            max-height: 120px;
            width: 120px;
            border-radius: 10px;
            border: 1px solid #eee;
            padding: 3px;
            margin: 10px;
            overflow: auto; /* Enable vertical scrollbar when content overflows */
            background-color: #fff;
        }
        .slicer {
            padding: 5px;
            border-radius: 5px;
        }
        .slicer-header {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }
        .slicer-options label {
            display: block;
            margin-bottom: 3px;
            color: #333;
        }
        .slicer-options input[type="checkbox"] {
            margin-right: 5px;
        }
        .slicer-options {
            white-space: nowrap; /* Prevent line breaks */
        }
        /* Centered Slicer Container (only for mergermarket since there is only one slicer) */
        .centered-slicer-container {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .slicer-open {
            display: block;
        }
        .slicer-closed {
            display: none;
        }

        /* Style the column search input boxes */
        .column-search {
            width: 100%;
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        /* for loading animation */
        .loading-container {
            display: flex;
            justify-content: center;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8); /* Semi-transparent background */
            z-index: 9999; /* Higher z-index to cover the entire page */
        }
        .loading-animation {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container-fluid">

            <!-- Back Button -->
            <a class="navbar-brand" href="/preview" data-bs-toggle="tooltip" data-bs-title="Go Back">
                <img src="../static/images/left-arrow.png" alt="Back" width="15" height="15">
            </a>

            <!-- Bootstrap's NavBar styling -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav nav-tabs me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link" href="/upload" style="color: white;">Upload</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/preview" style="color: white;">Preview Tables</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/mergermarket" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="MergerMarket">MM</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/marketscan" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="Market Scan" style="color: white;">MS</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/rollingshortlist" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="Rolling Shortlist" style="color: white;">RS</a>
                    </li>
                </ul>
            </div>

            <!-- Button Container on the top right hand corner of the navbar -->
            <div class="button-container">
                <div class="table-name"></div>
                <div class="upload-button" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="Upload Weekly MergerMarket"></div>
                <div class="populate-MS-button" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="Populate Market Scan"></div>
                <div class="LLM-button" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="Trigger LLM"></div>
                <div class="add-row-button" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="Add New Row"></div>
                <div class="save-button" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="Save Changes"></div>
                <div class="download-button" data-bs-toggle="tooltip" data-bs-title="Download MergerMarket into Excel"></div>
            </div>
        </div>
    </nav>

    <!-- Modal for Upload functionality -->
    <div class="modal fade" id="uploadModal" tabindex="-2" aria-labelledby="uploadModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-md">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="uploadModalLabel">Upload Weekly MergerMarket</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="max-height: 400px; overflow-y: auto;">
                    <h1>Excel File Upload to BigQuery</h1>
                    <form id="uploadForm" enctype="application/x-www-form-urlencoded" style="margin-bottom: 10px;">
                        <input type="file" id="fileInput" name="files" accept=".xls, .xlsx" multiple>
                        <label for="tableIdInput" style="margin-left: 10px;">Table ID:</label>
                        <input type="text" id="tableIdInput" name="tableId" disabled>
                        <!-- <button type="submit">Upload</button> -->
                    </form>
                    <div id="previewArea">
                        <!-- The content of the selected Excel file will be displayed here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="uploadModalConfirm">Upload</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for confirmation of populating Market Scan -->
    <div class="modal fade" id="populateMSModal" tabindex="-2" aria-labelledby="populateMSModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-md">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="populateMSModalLabel">Populate Market Scan</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="max-height: 400px; overflow-y: auto;">
                    
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="populateMSModalConfirm">Populate</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for adding a new row -->
    <div class="modal fade" id="addRowModal" tabindex="-1" aria-labelledby="addRowModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addRowModalLabel">Add Row</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="max-height: 400px; overflow-y: auto;">
                    <table class="table">
                        <thead>
                            <tr>
                                <!-- Header columns based on the BigQuery MergerMarket table headers -->
                                <th>Opportunity_ID</th>
                                <th>Date</th>
                                <th>Value INR_m</th>
                                <th>Value Description</th>
                                <th>Heading</th>
                                <th>Opportunity</th>
                                <th>Targets</th>
                                <th>Lead type</th>
                                <th>Type of transaction</th>
                                <th>HS sector classification</th>
                                <th>Short BD</th>
                                <th>Source</th>
                                <th>Intelligence Type</th>
                                <th>Intelligence Grade</th>
                                <th>Intelligence Size</th>
                                <th>Stake Value</th>
                                <th>Dominant Sector</th>
                                <th>Sectors</th>
                                <th>Sub Sectors</th>
                                <th>Dominant Geography</th>
                                <th>Geography</th>
                                <th>States</th>
                                <th>Topics</th>
                                <th>Bidders</th>
                                <th>Vendors</th>
                                <th>Issuers</th>
                                <th>Competitors</th>
                                <th>Others</th>
                                <th>Completed</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <!-- Input fields for each column (follows BigQuery's data types) -->
                                <td><input type="number" id="new-opportunityId"></td>
                                <td><input type="date" id="new-date"></td>
                                <td><input type="text" id="new-INRm"></td>
                                <td><input type="text" id="new-valueDesc"></td>
                                <td><input type="text" id="new-heading"></td>
                                <td><input type="text" id="new-opportunity"></td>
                                <td><input type="text" id="new-targets"></td>
                                <td><input type="text" id="new-leadtype"></td>
                                <td><input type="text" id="new-typetrans"></td>
                                <td><input type="text" id="new-hssector"></td>
                                <td><input type="text" id="new-shortbd"></td>
                                <td><input type="text" id="new-source"></td>
                                <td><input type="text" id="new-inteltype"></td>
                                <td><input type="text" id="new-intelgrade"></td>
                                <td><input type="text" id="new-intelsize"></td>
                                <td><input type="text" id="new-stakevalue"></td>
                                <td><input type="text" id="new-domsect"></td>
                                <td><input type="text" id="new-sect"></td>
                                <td><input type="text" id="new-subsect"></td>
                                <td><input type="text" id="new-domgeog"></td>
                                <td><input type="text" id="new-geog"></td>
                                <td><input type="text" id="new-states"></td>
                                <td><input type="text" id="new-topics"></td>
                                <td><input type="text" id="new-bidders"></td>
                                <td><input type="text" id="new-vendors"></td>
                                <td><input type="text" id="new-issuers"></td>
                                <td><input type="text" id="new-competitors"></td>
                                <td><input type="text" id="new-others"></td>
                                <td><input type="text" id="new-completed"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="addRowConfirmButton">Add Row</button>
                </div>
            </div>
        </div>
    </div>

    <div id="slicer-container">
        <div>
            <button id="toggle-button" class="btn" type="button" data-bs-toggle="collapse" data-bs-target="#centered-slicer-container" aria-expanded="true" aria-controls="centered-slicer-container">
                <img id="arrow-image" src="../static/images/Up_arrow.png" width="10" height="10">
            </button>
        </div>
        <!-- Dropdown slicers will be generated here -->
    </div>

    <div class="table-details" style="display: none;">
        <!-- Table Data from BigQuery will be generated here -->
    </div>

    <div class="loading-container">
        <div class="loading-animation"></div>
    </div>

<!-- Add SheetJS library for Excel file handling -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.4/xlsx.full.min.js"></script>
<!-- Bootstrap JS -->
<!-- Include the XLSX.js library -->
<script src="path/to/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" crossorigin="anonymous"></script>
<!-- jQuery for making AJAX requests -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
    const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))

    $(document).ready(function() {
        // Show the loading animation upon loading of the MergerMarket table (time it takes to load the data from BigQuery)
        $('.loading-container').show();
        displayMergerMarket();

        // To display MergerMarket table
        function displayMergerMarket() {

            /* The following code is making an AJAX GET request to a local server at
            `http://127.0.0.1:5002/get_mergermarket` to fetch data. Once the data is fetched, it
            generates an HTML table using the fetched data and displays it on the webpage. The table
            headers are generated based on the `columnOrder` array, and the table rows are generated
            based on the data received. The code also includes functionality for searching and
            filtering the table data based on user input. Additionally, it appends buttons for
            saving changes, adding rows, populating market scan */

            $.get(`http://127.0.0.1:5002/get_mergermarket`, function(data) {
                // Hide the loading animation upon loading of data from BigQuery
                $('.loading-container').hide();
                tableName = "MergerMarket"
                const columnOrder = [
                    "Opportunity_ID",
                    "Date",
                    "Value INR_m",
                    "Value Description",
                    "Heading",
                    "Opportunity",
                    "Targets",
                    "Lead type",
                    "Type of transaction",
                    "HS sector classification",
                    "Short BD",
                    "Source",
                    "Intelligence Type",
                    "Intelligence Grade",
                    "Intelligence Size",
                    "Stake Value",
                    "Dominant Sector",
                    "Sectors",
                    "Sub Sectors",
                    "Dominant Geography",
                    "Geography",
                    "States",
                    "Topics",
                    "Bidders",
                    "Vendors",
                    "Issuers",
                    "Competitors",
                    "Others",
                    "Completed"
                ];
                const tableData = data;
                // Generate a table HTML using the fetched data
                let tableHtml = '<table class="table" id="MM_table">';
                // Generate table headers
                tableHtml += '<thead><tr>';
                for (const columnName of columnOrder) {
                    tableHtml += `<th>${columnName}</th>`;
                }
                tableHtml += '</tr></thead>';

                // For Search text input
                tableHtml += '<thead><tr>';
                for (const columnName of columnOrder) {
                    tableHtml += `
                        <th><input type="text" class="column-search" data-col-name="${columnName}" placeholder="Search ${columnName}"></th>
                    `;
                    
                }
                tableHtml += '</tr></thead>';

                // Generate table rows
                tableHtml += '<tbody>';
                for (const opportunityId in tableData) {
                    const row = tableData[opportunityId];
                    const completedValue = row["Completed"];
                    // Check if the "Completed" column has the value "Available"
                    const cellColor = completedValue === "Available" ? '#ded1e5' : ''; // Set the row color conditionally

                    tableHtml += `<tr>`;
                    for (const columnName of columnOrder) {
                        const cellContent = row[columnName];
                        if (cellContent !== null) {
                            if (cellContent.length > 30) {
                                const uniqueID = `modal-${columnName.trim().substring(0, 3)}`;
                                tableHtml += `
                                    <td data-col-name="${columnName}" data-full-content='${cellContent}'>${cellContent.substring(0, 30)}
                                        <span><button class="expand-button" data-bs-toggle="modal" data-bs-target="#${uniqueID}">...</button></span>
                                        <div class="modal fade" id="${uniqueID}" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                                            <div class="modal-dialog modal-dialog-scrollable">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                    </div>
                                                    <div class="modal-body"></div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary close-modal-button" data-bs-dismiss="modal">Close</button>
                                                        <button type="button" id="save-changes" class="btn btn-primary">Save changes</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                    `;
                            } else {
                                if (columnName === "Opportunity_ID") {
                                    tableHtml += `<td data-col-name="${columnName}" contenteditable="true" style="background-color: ${cellColor};">${cellContent}</td>`;
                                } else {
                                    tableHtml += `<td data-col-name="${columnName}" contenteditable="true">${cellContent}</td>`;
                                }
                            }
                        } else {
                            tableHtml += `<td data-col-name="${columnName}" contenteditable="true"> </td>`;
                        }
                    }
                    tableHtml += '</tr>';
                }

                // Add editable attribute to each cell
                tableHtml = tableHtml.replace(/<td>/g, '<td contenteditable="true">');

                // Append table name
                tableNameHtml = `<p style='margin-right: 10px; margin-top: 10px; color: white;'>${tableName}</p>`
                $('.table-name').html(tableNameHtml);

                // Append Save Changes button
                uploadHtml = '<button id="upload-MM" class="btn"><img src="../static/images/upload.png" alt="Save Changes" width="15" height="15"></button>';
                $('.upload-button').html(uploadHtml);

                // Append Save Changes button
                saveHtml = '<button id="save-changes" class="btn"><img src="../static/images/diskette.png" alt="Save Changes" width="15" height="15"></button>';
                $('.save-button').html(saveHtml);

                // Append Add Row button
                addHtml = '<button id="add-row" class="btn"><img src="../static/images/plus.png" alt="Add Row" width="15" height="15"></button>';
                $('.add-row-button').html(addHtml);

                // Append Populate Market Scan button
                populateHtml = '<button id="populate-MS" class="btn"><img src="../static/images/move_tables.png" alt="Populate MS" width="15" height="15"></button>';
                $('.populate-MS-button').html(populateHtml);

                // Append LLM button
                LLMHtml = '<button id="LLM-button" class="btn"><img src="../static/images/brain.png" alt="Run LLM Model" width="15" height="15"></button>';
                $('.LLM-button').html(LLMHtml);

                // Update the table details placeholder and show it
                $('.table-details').html(tableHtml).show();

                // Hide the tile container
                $('.tile-container').hide();

                // Generate dropdown slicers for each column
                const slicerContainer = document.getElementById("slicer-container");
                slicerHTML = `
                <div class="container">
                    <div class="row">
                `;
                for (const columnName of columnOrder) {
                    if (["Completed"].includes(columnName)) {
                        const uniqueValues = [...new Set(tableData.map(row => row[columnName]))];
                        slicerHTML += `
                        <div class="centered-slicer-container show" id="centered-slicer-container">
                            <div class="slicer-container">
                                <div class="slicer">
                                    <div class="slicer-header">${columnName}</div>
                                    <div class="slicer-options">
                        `
                        for (const value of uniqueValues) {
                            slicerHTML += `
                                <label><input type="checkbox" class="slicer-checkbox" value="${value}">${value}</label>
                            `
                        }
                        slicerHTML += `
                                    </div>
                                </div>
                            </div>
                        </div>
                        `
                    }
                }
                slicerHTML += `
                    </div>
                </div>
                `
                slicerContainer.innerHTML += slicerHTML;

                // Function for Slicer Filtering
                function applySlicerFiltering() {
                    $('.slicer-container').on('input', 'input[type="checkbox"]', function () {
                        // Get all selected slicer values and their corresponding column names
                        const selectedSlicerValues = {};
                        $('.slicer-container').each(function () {
                            const slicerHeading = $(this).find('.slicer-header').text().trim();
                            const selectedValues = [];
                            $(this).find('input[type="checkbox"]:checked').each(function () {
                                selectedValues.push($(this).val());
                            });
                            if (selectedValues.length > 0) {
                                selectedSlicerValues[slicerHeading] = selectedValues;
                                console.log(slicerHeading + ": " + selectedValues);
                            }
                        });
                        // Hide or show table rows based on selected slicer values
                        $('.table tbody tr').each(function () {
                            let rowVisible = true;
                            const $row = $(this);
                            // Check if all selected slicer values match in their respective columns
                            for (const slicerHeading in selectedSlicerValues) {
                                const columnIndex = columnOrder.indexOf(slicerHeading);
                                if (columnIndex !== -1) {
                                    const cellText = $row.find(`td:eq(${columnIndex})`).text().toLowerCase();
                                    const selectedValues = selectedSlicerValues[slicerHeading];
                                    let matchesAllValues = true;
                                    for (const value of selectedValues) {
                                        if (!cellText.includes(value.toLowerCase())) {
                                            matchesAllValues = false;
                                            break;
                                        }
                                    }
                                    if (!matchesAllValues) {
                                        rowVisible = false;
                                        break; // No need to check further
                                    }
                                }
                            }
                            // Toggle row visibility
                            if (rowVisible) {
                                $row.show();
                            } else {
                                $row.hide();
                            }
                        });
                    });
                }

                // For Search Function
                function applyColumnSearch() {
                    $('.column-search').on('input', function () {
                        // Get all search values from all search inputs
                        const searchValues = {};
                        $('.column-search').each(function () {
                            const columnName = $(this).data('col-name');
                            const searchText = $(this).val().toLowerCase();
                            searchValues[columnName] = searchText;
                        });
                        $('.table tbody tr').each(function () {
                            let rowVisible = true;
                            const $row = $(this);
                            // Check if any search text matches in any of the columns
                            for (const columnName of columnOrder) {
                                const cellText = $row.find(`td[data-col-name="${columnName}"]`).text().toLowerCase();
                                const searchText = searchValues[columnName];
                                if (searchText && !cellText.includes(searchText)) {
                                    rowVisible = false;
                                    break;
                                }
                            }
                            // Toggle row visibility
                            if (rowVisible) {
                                $row.show();
                            } else {
                                $row.hide();
                            }
                        });
                    });
                }

                // calling the Slicer and Search functions to apply them to the displayed table
                applySlicerFiltering();
                applyColumnSearch();
                console.log("display successful");

                // FOLLOWING code is to download the BigQuery MergerMarket dataset as an excel file on the user's local machine
                // Create a button element (following this are all DOM manipulation)
                const downloadButton = document.createElement('button');
                downloadButton.id = 'download-button';
                downloadButton.className = 'btn';
                // Create an image element for the button
                const downloadImage = document.createElement('img');
                downloadImage.src = '../static/images/download_icon.png';
                downloadImage.alt = 'Download Table';
                downloadImage.width = 15;
                downloadImage.height = 15;
                downloadButton.appendChild(downloadImage);
                downloadButton.addEventListener('click', async () => {
                    const response = await fetch('http://127.0.0.1:5002/download_mergermarket');
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'MergerMarket.xlsx';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                });
                // Append the button to the button container
                const downloadDiv = document.querySelector('.download-button');
                downloadDiv.appendChild(downloadButton);
            });
        }

        // Function to update the MergerMarket table
        function updateMergerMarket() {
            const editedCells = $('.table td.editing'); // Get all edited cells
            const editedModal = $('.modal-body.editing'); // Get the edited cell inside the modal
            let showAlert = true; // Initialize the showAlert flag as true
            const updatedRows = [];
            if (editedCells.length > 0) {
                showAlert = false;
                editedCells.each(function () {
                const editedCell = $(this);
                const opportunityId = editedCell.closest('tr').find('td:nth-child(1)').text(); // 1st column is Opportunity_ID (unique row number)
                const columnName = editedCell.data('col-name');
                const cellValue = editedCell.text();
                // console.log for debugging purposes
                console.log(opportunityId);
                console.log(columnName);
                console.log(cellValue);
                    updatedRows.push({
                        row_id: opportunityId,
                        column_name: columnName,
                        edited_value: cellValue
                    });
                });
            }
            if (editedModal.length > 0) {
                // Get the updated content from the modal and update the corresponding cell
                const modalId = editedModal.closest('.modal').attr('id'); // Get the modal ID
                const editedContent = $(`#${modalId} .modal-body`).text(); // Get the content from the modal
                const opportunityId = editedModal.closest('tr').find('td:nth-child(1)').text(); // 1st column is Opportunity_ID
                const columnName = editedModal.closest('.table td').data('col-name');
                updatedRows.push({
                    row_id: opportunityId,
                    column_name: columnName,
                    edited_value: editedContent
                });
                showAlert = false; // Modal is edited, so do not show the alert
            }
            // console.log to show developer updated rows during testing
            console.log(updatedRows);
            if (showAlert) {
                alert("No cell is being edited.");
                return;
            }
            // Send the updated data to the backend using fetch
            fetch('http://127.0.0.1:5002/update_mergermarket', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updatedRows)
            })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error("An error occurred while saving changes.");
                    }
                })
                .then(data => {
                    console.log(data);
                    if (data.success) {
                        console.log("edit successful!");
                        alert("Edit successful!");
                        setTimeout(function(){
                            window.location.reload();
                        }, 5000); // Reload the table after a successful update
                    } else {
                        displayMergerMarket();
                        displayErrorMessage("An error occurred while saving changes.");
                    }
                })
                .catch(error => {
                    console.error(error);
                    displayMergerMarket();
                    displayErrorMessage("An error occurred while saving changes.");
                });
        }

        // FOLLOWING functions are for the Add Row function on the MergerMarket table
        // Click event handler for the "Add Row" button
        $('.add-row-button').click(function() {
            $('#addRowModal').modal('show');
        });
        // Click event handler for the "Add Row" modal's "Add Row" button
        $('#addRowConfirmButton').click(function() {
            // Collect data from input fields
            const newRowData = {
                Opportunity_ID: parseFloat($('#new-opportunityId').val()) || 0, // Use 0 as a default value if not provided
                Date: $('#new-date').val() || new Date().toISOString().slice(0, 10), // Use the current date if not provided
                Value_INR_m: $('#new-INRm').val() || " ",
                Value_Description: $('#new-valueDesc').val() || " ",
                Heading: $('#new-heading').val() || " ",
                Opportunity: $('#new-opportunity').val() || " ",
                Targets: $('#new-targets').val() || " ",
                Lead_Type: $('#new-leadtype').val() || " ",
                Type_of_transaction: $('#new-typetrans').val() || " ",
                HS_sector_classification: $('#new-hssector').val() || " ",
                Short_BD: $('#new-shortbd').val() || " ",
                Source: $('#new-source').val() || " ",
                Intelligence_Type: $('#new-inteltype').val() || " ",
                Intelligence_Grade: $('#new-intelgrade').val() || " ",
                Intelligence_Size: $('#new-intelsize').val() || " ",
                Stake_Value: $('#new-stakevalue').val() || " ",
                Dominant_Sector: $('#new-domsect').val() || " ",
                Sectors: $('#new-sect').val() || " ",
                Sub_Sectors: $('#new-subsect').val() || " ",
                Dominant_Geography: $('#new-domgeog').val() || " ",
                Geography: $('#new-geog').val() || " ",
                States: $('#new-states').val() || " ",
                Topics: $('#new-topics').val() || " ",
                Bidders: $('#new-bidders').val() || " ",
                Vendors: $('#new-vendors').val() || " ",
                Issuers: $('#new-issuers').val() || " ",
                Competitors: $('#new-competitors').val() || " ",
                Others: $('#new-others').val() || " ",
                Completed: $('#new-completed').val() || " ",
            };
            // Send the new row data to the server
            $.ajax({
                url: 'http://127.0.0.1:5002/add_mergermarket_row',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(newRowData),
                success: function(response) {
                    if (response.success) {
                        alert('Row added successfully.');
                        setTimeout(function(){
                            window.location.reload();
                        }, 5000); // Reload the table after a successful update
                    } else {
                        alert('Error adding row.');
                    }
                    $('#addRowModal').modal('hide');
                },
                error: function() {
                    alert('Error adding row.');
                    $('#addRowModal').modal('hide');
                }
            });
        });

        // FOLLOWING few functions are for the 'Save Changes' functionality
        // Initialize an array to keep track of editing cells
        const editingCells = [];

        // this is for showing a cell's full content in a modal
        $(document).on('click', '.expand-button', function () {
            const modalId = $(this).data('bs-target'); // Get the modal's target ID
            const cellContent = $(this).closest('td').data('full-content');
            console.log(cellContent);
            // Find the modal using its unique ID and show it
            $(modalId).find('.modal-body').html(`<div contenteditable="true">${cellContent}</div>`);
            // Add the "editing" class to the cell
            $(modalId).find('.modal-body').addClass('editing');
            if (!$(this).closest('td').hasClass('expanded')) {
                // Add the "expanded" class to the cell if it's not already expanded
                $(this).closest('td').addClass('expanded');
            } else {
                // Remove the "expanded" class if it's already expanded (e.g., when closing the modal)
                $(this).closest('td').removeClass('expanded');
            }
            $(modalId).modal('show');
        });

        // Click event handler for cells with contenteditable="true"
        $(document).on('click', '.table td[contenteditable="true"]', function() {
            console.log("This cell is being edited!");
            $(this).addClass('editing');
            // Add the cell to the editingCells array
            editingCells.push(this);
        });

        // Click event handler for #save-changes button
        $(document).on('click', '#save-changes', function() {
            const tableName = $('.table-name').text();
            updateMergerMarket();
            // Remove the "editing" and "expanded" classes from all cells in the editingCells array
            editingCells.forEach(function (cell) {
                $(cell).removeClass('editing expanded');
            });
            // Clear the editingCells array
            editingCells.length = 0;
        });

        // FOLLOWING is for the integration between the MergerMarket and the Market Scan tables
        // Add an event listener to the "Populate MS" button
        $('.populate-MS-button').on('click', function() {
            // Initialize variables to store the first and last Opportunity_ID
            let firstOpportunityId = null;
            let lastOpportunityId = null;
            let numRows = 0;
            // Iterate through each table row
            $('#MM_table tbody tr').each(function() {
                // Check if the "Completed" column has the value "Available"
                const completedValue = $(this).find('td[data-col-name="Completed"]').text();
                if (completedValue === 'Available') {
                    numRows++;
                    // Retrieve the Opportunity_ID for this row
                    const opportunityId = $(this).find('td[data-col-name="Opportunity_ID"]').text();
                    // Set the first Opportunity_ID if it's not set yet
                    if (firstOpportunityId === null) {
                        firstOpportunityId = opportunityId;
                    }
                    // Always update the last Opportunity_ID to the current one
                    lastOpportunityId = opportunityId;
                }
            });
            // Create the modal content
            let modalContent = '';
            if (firstOpportunityId !== null) {
                modalContent = `
                    You are currently going to populate Market Scan with <b>${numRows}</b> rows where deals are "Available".<br><br>
                    First Opportunity_ID: ${firstOpportunityId}<br>
                    Last Opportunity_ID: ${lastOpportunityId || 'No available Opportunity_IDs'}
                `;
            } else {
                modalContent = 'No rows with "Completed" set to "Available" found.';
            }
            // Update the modal body with the content
            $('.modal-body').html(modalContent);
            // Show the confirmation modal
            $('#populateMSModal').modal('show');
        });

        // Upon button click of the 'Populate MS' button
        $('#populateMSModalConfirm').on('click', function() {
            // Add logic for populating Market Scan here

            // Close the confirmation modal
            $('#populateMSModal').modal('hide');
        });

        // Upon button click of the LLM button
        $('.LLM-button').on('click', function() {
            confirm("Confirm run LLM model?")
        });

        // Upon button click of the LLM button
        $('.upload-button').on('click', function() {
            $('#uploadModal').modal('show');
        });
        // Add an event listener to the file input element
        $('#fileInput').on('change', function (e) {
            const file = e.target.files[0];

            // Check if a file is selected
            if (file) {
                // Initialize a FileReader to read the Excel file
                const reader = new FileReader();
                reader.onload = function (e) {
                    const data = e.target.result;
                    // Parse the Excel data (you may need a library like XLSX.js)
                    // This code assumes you're using XLSX.js. Make sure to include the library in your HTML.
                    const workbook = XLSX.read(data, { type: 'binary' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const tableData = XLSX.utils.sheet_to_json(sheet, { header: 1, range: 5 });

                    // Create a table HTML to display the first 5 columns
                    let tableHtml = '<table class="table" id="previewTable">';
                    tableHtml += '<thead><tr>';
                    for (let i = 0; i < 5; i++) {
                        const cellValue = tableData[0][i] || '';
                        tableHtml += `<th>${cellValue}</th>`;
                    }
                    tableHtml += '</tr></thead>';

                    tableHtml += '<tbody>';
                    for (let row = 1; row < tableData.length; row++) {
                        tableHtml += '<tr>';
                        for (let col = 0; col < 5; col++) {
                            const cellValue = tableData[row][col] || '';
                            tableHtml += `<td>${cellValue}</td>`;
                        }
                        tableHtml += '</tr>';
                    }
                    tableHtml += '</tbody></table>';

                    // Display the table in the modal's preview area
                    $('#previewArea').html(tableHtml);
                };

                // Read the file as binary
                reader.readAsBinaryString(file);
            }
        });
    });
</script>
</body>
</html>
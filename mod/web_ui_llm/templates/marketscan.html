<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Previewing tables</title>
    <!-- Add Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f0f0;
        }

        .navbar {
            position: sticky;
            background-color: #f8f9fa;
            border-bottom: 1px solid #ddd;
            position: sticky;
            top: 0;
            z-index: 1000; /* Ensure Navbar is above other content */
        }

        .navbar-nav {
            margin-right: auto;
        }

        /* Add this CSS to style the displayed table */
        .table {
            width: 100%;
            border-collapse: collapse;
            position: relative;
        }

        .table th,
        .table td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }

        .table td {
            white-space: normal;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .table th {
            position: sticky;
            top: 0px; /* 63px for below navbar */
            background-color: #dbdbdb; /* Set the background color */
            color: black; /* Set the text color */
            z-index: 1001;
        }

        /* Add this CSS to adjust the layout when table is displayed */
        .table-details {
            max-width: 800px;
            padding: 0;
        }

        /* Add this CSS to change cell color when editing starts */
        .table td[contenteditable="true"]:focus {
            background-color: orange;
        }
        .table td.expanded div[contenteditable="true"]:focus {
            background-color: orange;
            padding: 8px;
            margin: -8px; /* Counteract padding to maintain cell size */
            border: 1px solid #ccc;
            white-space: normal;
            overflow: visible;
        }
        .table td.expanded {
            background-color: orange;
        }
        .table td.editing {
            background-color: orange;
        }

        .button-container {
            display: flex; /* Use flexbox to align buttons horizontally */
            align-items: center; /* Center items vertically within the container */
            margin-top: 10px; /* Adjust margin as needed */
        }

        .save-button,
        .add-row-button,
        .populate-RS-button {
            margin-right: 10px; /* Add space between buttons */
        }

        /* Add this CSS to style the "Expand" button */
        .expand-button {
            border-radius: 10px;
            border: none;
            display: inline-block;
            cursor: pointer;
        }

        /* for SLICER CONTAINER */
        #slicer-container {
            white-space: nowrap;
        }

        .slicer-container {
            display: inline-block;
            max-height: 150px;
            width: 200px;
            border-radius: 10px;
            border: 1px solid #eee;
            padding: 10px;
            margin: 10px;
            overflow: auto; /* Enable vertical scrollbar when content overflows */
            background-color: #fff;
        }

        .slicer {
            margin-bottom: 10px;
            padding: 5px;
            border-radius: 5px;
        }

        .slicer-header {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }

        .slicer-options label {
            display: block;
            margin-bottom: 3px;
            color: #333;
        }

        /* Style checkboxes to make them more visible */
        .slicer-options input[type="checkbox"] {
            margin-right: 5px;
        }

        .slicer-options {
            white-space: nowrap; /* Prevent line breaks */
        }

        /* Style the column search input boxes */
        .column-search {
            width: 100%;
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        /* for loading animation */
        .loading-container {
            display: flex;
            justify-content: center;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8); /* Semi-transparent background */
            z-index: 9999; /* Higher z-index to cover the entire page */
        }


        .loading-animation {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <!-- Back Button -->
            <a class="navbar-brand" href="/preview">
                <img src="../static/images/left-arrow.png" alt="Back" width="30" height="30">
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link" href="/upload">Upload</a>
                    </li>
                    <li class="nav-item active">
                        <a class="nav-link" href="/model_testing">Model Testing</a>
                    </li>
                    <li class="nav-item active">
                        <a class="nav-link" href="/preview">Preview Tables</a>
                    </li>
                </ul>
            </div>

            <div class="button-container">
                <div class="table-name"></div>
                <div class="populate-RS-button"></div>
                <div class="add-row-button"></div>
                <div class="save-button"></div>
            </div>
        </div>
    </nav>

    <!-- Modal for confirmation of populating Market Scan -->
    <div class="modal fade" id="populateRSModal" tabindex="-2" aria-labelledby="populateRSModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="populateRSModalLabel">Populate Rolling Shortlist</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="populateRS-modal-body" style="max-height: 400px; overflow-y: auto;">
                    
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="populateRSModalConfirm">Populate</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add a modal for adding a new row -->
    <div class="modal fade" id="addRowModal" tabindex="-1" aria-labelledby="addRowModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addRowModalLabel">Add Row</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="max-height: 400px; overflow-y: auto;">
                    <table class="table">
                        <thead>
                            <tr>
                                <!-- Header columns based on your BigQuery table headers -->
                                <th>Num</th>
                                <th>Picks</th>
                                <th>Captured in the week</th>
                                <th>Date</th>
                                <th>Lead type</th>
                                <th>Target HS industry classification</th>
                                <th>Dominant sector_as per MM</th>
                                <th>Sectors_as per MM</th>
                                <th>Sub Sectors_as per MM</th>
                                <th>HS Target region</th>
                                <th>Dominant country</th>
                                <th>Countries</th>
                                <th>Next Steps</th>
                                <th>Target</th>
                                <th>Target_Chinese</th>
                                <th>Deal intelligence</th>
                                <th>Short BD</th>
                                <th>Bidders</th>
                                <th>Sellers_or_Vendors</th>
                                <th>Type of transaction</th>
                                <th>Intelligence type_as per MM</th>
                                <th>Topics_as per MM</th>
                                <th>Value_USDm</th>
                                <th>Value description</th>
                                <th>Intelligence size</th>
                                <th>Intelligence size bucket</th>
                                <th>Stake value_percent</th>
                                <th>Held by ASPAC priority firm_Y_or_N</th>
                                <th>PE priority firm</th>
                                <th>Held since</th>
                                <th>Held for more than three years_Y_N_NA</th>
                                <th>KPMG credentials_PE_Company_Both_N</th>
                                <th>KPMG firm</th>
                                <th>Engagement partner</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <!-- Input fields for each column -->
                                <td><input type="number" id="new-num"></td>
                                <td><input type="checkbox" id="new-picks"></td>
                                <td><input type="text" id="new-capturedWeek"></td>
                                <td><input type="date" id="new-date"></td>
                                <td><input type="text" id="new-leadType"></td>
                                <td><input type="text" id="new-HSIndustryClassification"></td>
                                <td><input type="text" id="new-dominantSectorMM"></td>
                                <td><input type="text" id="new-sectorsMM"></td>
                                <td><input type="text" id="new-subSectorsMM"></td>
                                <td><input type="text" id="new-HSTargetRegion"></td>
                                <td><input type="text" id="new-dominantCountry"></td>
                                <td><input type="text" id="new-countries"></td>
                                <td><input type="text" id="new-nextSteps"></td>
                                <td><input type="text" id="new-target"></td>
                                <td><input type="text" id="new-targetChinese"></td>
                                <td><input type="text" id="new-dealIntelligence"></td>
                                <td><input type="text" id="new-shortBD"></td>
                                <td><input type="text" id="new-bidders"></td>
                                <td><input type="text" id="new-sellersVendors"></td>
                                <td><input type="text" id="new-transactionType"></td>
                                <td><input type="text" id="new-intelligenceType"></td>
                                <td><input type="text" id="new-topicsMM"></td>
                                <td><input type="text" id="new-valueUSDm"></td>
                                <td><input type="text" id="new-valueDescription"></td>
                                <td><input type="text" id="new-intelligenceSize"></td>
                                <td><input type="text" id="new-intelligenceSizeBucket"></td>
                                <td><input type="text" id="new-stakeValuePercent"></td>
                                <td><input type="text" id="new-heldByASPAC"></td>
                                <td><input type="text" id="new-pePriorityFirm"></td>
                                <td><input type="text" id="new-heldSince"></td>
                                <td><input type="text" id="new-heldThreeYears"></td>
                                <td><input type="text" id="new-kpmgCredentials"></td>
                                <td><input type="text" id="new-kpmgFirm"></td>
                                <td><input type="text" id="new-engagementPartner"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="addRowConfirmButton">Add Row</button>
                </div>
            </div>
        </div>
    </div>

    <div id="slicer-container">
        <!-- Dropdown slicers will be generated here -->
    </div>

    <div class="table-details" style="display: none;">
        <!-- Table Data from BigQuery will be generated here -->
    </div>

    <div class="loading-container">
        <div class="loading-animation"></div>
    </div>

<!-- Add any JavaScript links or scripts here -->
<!-- Add the SheetJS library for Excel file handling -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.4/xlsx.full.min.js"></script>
<!-- Add Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" crossorigin="anonymous"></script>

<!-- Add jQuery for making AJAX requests -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    $(document).ready(function() {
        // Show the loading animation
        $('.loading-container').show();
        displayMarketScan();

        // To display Market Scan table
        function displayMarketScan() {
            $.get(`http://127.0.0.1:5003/get_marketscan`, function(data) {
                // Hide the loading animation
                $('.loading-container').hide();
                tableName = "Market_Scan"

                const columnOrder = [
                    "Num",
                    "Picks",
                    "Captured in the week",
                    "Date",
                    "Lead type",
                    "Target HS industry classification",
                    "Dominant sector_as per MM",
                    "Sectors_as per MM",
                    "Sub Sectors_as per MM",
                    "HS Target region",
                    "Dominant country",
                    "Countries",
                    "Next Steps",
                    "Target",
                    "Target_Chinese",
                    "Deal intelligence",
                    "Short BD",
                    "Bidders",
                    "Sellers_or_Vendors",
                    "Type of transaction",
                    "Intelligence type_as per MM",
                    "Topics_as per MM",
                    "Value_USDm",
                    "Value description",
                    "Intelligence size",
                    "Intelligence size bucket",
                    "Stake value_percent",
                    "Held by ASPAC priority firm_Y_or_N",
                    "PE priority firm ",
                    "Held since",
                    "Held for more than three years_Y_N_NA",
                    "KPMG credentials_PE_Company_Both_N",
                    "KPMG firm",
                    "Engagement partner",
                ];

                const tableData = data; // Already parsed JSON

                // Generate a table HTML using the fetched data
                let tableHtml = '<table class="table" id="MS_table">';
                    
                // Generate table headers
                tableHtml += '<thead><tr>';
                for (const columnName of columnOrder) {
                    tableHtml += `<th>${columnName}</th>`;
                }
                tableHtml += '</tr></thead>';
                
                // For Search text input
                tableHtml += '<thead><tr>';
                for (const columnName of columnOrder) {
                    tableHtml += `
                        <th><input type="text" class="column-search" data-col-name="${columnName}" placeholder="Search ${columnName}"></th>
                    `;
                    
                }
                tableHtml += '</tr></thead>';

                // Generate table rows
                tableHtml += '<tbody>';
                for (const opportunityId in tableData) {
                    const row = tableData[opportunityId];
                    tableHtml += '<tr>';
                    for (const columnName of columnOrder) {
                        const cellContent = row[columnName];
                        if (columnName == "Picks") {
                            // Modify this block to display a checkbox
                            tableHtml += `<td data-col-name="${columnName}" contenteditable="true">`;
                            tableHtml += `<input type="checkbox" ${cellContent ? 'checked' : ''}/>`;
                            tableHtml += `</td>`;
                        }
                        else if (cellContent !== null) {
                            if (cellContent.length > 30) {
                                const uniqueID = `modal-${columnName.trim().substring(0, 3)}`;
                                tableHtml += `
                                    <td data-col-name="${columnName}" data-full-content="${cellContent}">${cellContent.substring(0, 30)}
                                        <span><button class="expand-button" data-bs-toggle="modal" data-bs-target="#${uniqueID}">...</button></span>
                                        <div class="modal fade" id="${uniqueID}" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                                            <div class="modal-dialog modal-dialog-scrollable">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                    </div>
                                                    <div class="modal-body"></div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary close-modal-button" data-bs-dismiss="modal">Close</button>
                                                        <button type="button" id="save-changes" class="btn btn-primary">Save changes</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                    `;
                            } else {
                                tableHtml += `<td data-col-name="${columnName}" contenteditable="true">${cellContent}</td>`;
                            }
                        } else {
                            tableHtml += `<td data-col-name="${columnName}" contenteditable="true"> </td>`;
                        }
                    }
                    tableHtml += '</tr>';
                }

                // Add editable attribute to each cell
                tableHtml = tableHtml.replace(/<td>/g, '<td contenteditable="true">');

                // Append table name
                tableNameHtml = `<h4 style='margin-right: 10px;'>${tableName}</h4>`
                $('.table-name').html(tableNameHtml);

                // Append Save Changes button
                saveHtml = '<button id="save-changes" class="btn btn-primary">Save Changes</button>';
                $('.save-button').html(saveHtml);

                // Append Add Row button
                addHtml = '<button id="add-row" class="btn btn-success"><img src="../static/images/plus.png" alt="Add Row" width=25 height=25></button>';
                $('.add-row-button').html(addHtml);

                // Append Populate Rolling Shortlist button
                populateHtml = '<button id="populate-RS" class="btn" style="background-color: #9900ffff; color: white;">Populate RS</button>';
                $('.populate-RS-button').html(populateHtml);

                // Update the table details placeholder and show it
                $('.table-details').html(tableHtml).show();

                // Hide the tile container
                $('.tile-container').hide();

                // Generate dropdown slicers for each column
                const slicerContainer = document.getElementById("slicer-container");

                slicerHTML = ``;

                for (const columnName of columnOrder) {
                    if (["Lead type", "Target HS industry classification", "HS Target region", "Dominant country", "Intelligence size bucket", "Type of transaction", "Held by ASPAC priority firm_Y_or_N", "KPMG credentials_PE_Company_Both_N"].includes(columnName)) {
                        const uniqueValues = [...new Set(tableData.map(row => row[columnName]))];

                        slicerHTML += `
                        <div class="slicer-container">
                            <div class="slicer">
                                <div class="slicer-header">${columnName}</div>
                                <div class="slicer-options">
                        `

                        for (const value of uniqueValues) {
                            slicerHTML += `
                                <label><input type="checkbox" class="slicer-checkbox" value="${value}">${value}</label>
                            `
                        }

                        slicerHTML += `
                                </div>
                            </div>
                        </div>
                        `
                    }
                }

                slicerContainer.innerHTML = slicerHTML;

                // For Search Function
                function applyColumnSearch() {
                    $('.column-search').on('input', function () {
                        // Get all search values from all search inputs
                        const searchValues = {};
                        $('.column-search').each(function () {
                            const columnName = $(this).data('col-name');
                            const searchText = $(this).val().toLowerCase();
                            searchValues[columnName] = searchText;
                        });

                        $('.table tbody tr').each(function () {
                            let rowVisible = true;
                            const $row = $(this);

                            // Check if any search text matches in any of the columns
                            for (const columnName of columnOrder) {
                                const cellText = $row.find(`td[data-col-name="${columnName}"]`).text().toLowerCase();
                                const searchText = searchValues[columnName];
                                if (searchText && !cellText.includes(searchText)) {
                                    rowVisible = false;
                                    break;
                                }
                            }

                            // Toggle row visibility
                            if (rowVisible) {
                                $row.show();
                            } else {
                                $row.hide();
                            }
                        });
                    });
                }

                function applySlicerFiltering() {
                    $('.slicer-container').on('input', 'input[type="checkbox"]', function () {
                        // Get all selected slicer values and their corresponding column names
                        const selectedSlicerValues = {};
                        $('.slicer-container').each(function () {
                            const slicerHeading = $(this).find('.slicer-header').text().trim();
                            const selectedValues = [];
                            $(this).find('input[type="checkbox"]:checked').each(function () {
                                selectedValues.push($(this).val());
                            });
                            if (selectedValues.length > 0) {
                                selectedSlicerValues[slicerHeading] = selectedValues;
                                console.log(slicerHeading + ": " + selectedValues);
                            }
                        });

                        // Hide or show table rows based on selected slicer values
                        $('.table tbody tr').each(function () {
                            let rowVisible = true;
                            const $row = $(this);

                            // Check if all selected slicer values match in their respective columns
                            for (const slicerHeading in selectedSlicerValues) {
                                const columnIndex = columnOrder.indexOf(slicerHeading);

                                if (columnIndex !== -1) {
                                    const cellText = $row.find(`td:eq(${columnIndex})`).text().toLowerCase();
                                    const selectedValues = selectedSlicerValues[slicerHeading];
                                    let matchesAllValues = true;

                                    for (const value of selectedValues) {
                                        if (!cellText.includes(value.toLowerCase())) {
                                            matchesAllValues = false;
                                            break;
                                        }
                                    }

                                    if (!matchesAllValues) {
                                        rowVisible = false;
                                        break; // No need to check further
                                    }
                                }
                            }

                            // Toggle row visibility
                            if (rowVisible) {
                                $row.show();
                            } else {
                                $row.hide();
                            }
                        });
                    });
                }

                applyColumnSearch();
                applySlicerFiltering();
                console.log("display successful");

                // Create a button element
                const downloadButton = document.createElement('button');
                downloadButton.id = 'download-button';
                downloadButton.className = 'btn btn-warning';

                // Create an image element for the button
                const downloadImage = document.createElement('img');
                downloadImage.src = '../static/images/download_icon.png'; // Set the image source
                downloadImage.alt = 'Download Table'; // Set alt text for accessibility
                downloadImage.width = 20; // Set the width
                downloadImage.height = 20; // Set the height

                downloadButton.appendChild(downloadImage); // Append the image to the button

                downloadButton.addEventListener('click', async () => {
                    const response = await fetch('http://127.0.0.1:5003/download_marketscan');
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'Market Scan.xlsx';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                });

                // Append the button to the button container
                const buttonContainer = document.querySelector('.button-container');
                buttonContainer.appendChild(downloadButton);
            });
        }


        // Function specifically for Market Scan table
        function updateMarketScan() {
            const editedCells = $('.table td.editing'); // Get all edited cells
            const editedModal = $('.modal-body.editing'); // Get the edited cell inside the modal

            let showAlert = true; // Initialize the showAlert flag as true

            const updatedRows = [];

            if (editedCells.length > 0) {
                showAlert = false;

                editedCells.each(function () {
                    const editedCell = $(this);
                    const Num = editedCell.closest('tr').find('td:nth-child(1)').text(); // 1st column is Num (unique row number)
                    const columnName = editedCell.data('col-name');
                    let cellValue;

                    // Handle the "Picks" column checkbox value
                    if (columnName === "Picks") {
                        const checkbox = editedCell.find('input[type="checkbox"]');
                        cellValue = checkbox.is(':checked'); // Get the checked state of the checkbox
                        if (cellValue === true) {
                            cellValue = "True"
                        } 
                    } else {
                        cellValue = editedCell.text();
                    }

                    console.log(Num);
                    console.log(columnName);
                    console.log(cellValue);

                    updatedRows.push({
                        row_id: Num,
                        column_name: columnName,
                        edited_value: cellValue
                    });
                });
            }

            if (editedModal.length > 0) {
                // Get the updated content from the modal and update the corresponding cell
                const modalId = editedModal.closest('.modal').attr('id'); // Get the modal ID
                const editedContent = $(`#${modalId} .modal-body`).text(); // Get the content from the modal

                const Num = editedModal.closest('tr').find('td:nth-child(1)').text(); // 1st column is Num
                const columnName = editedModal.closest('.table td').data('col-name');

                updatedRows.push({
                    row_id: Num,
                    column_name: columnName,
                    edited_value: editedContent
                });

                showAlert = false; // Modal is edited, so do not show the alert
            }

            console.log(updatedRows);

            if (showAlert) {
                alert("No cell is being edited.");
                return;
            }

            // Send the updated data to the backend using fetch
            fetch('http://127.0.0.1:5003/update_marketscan', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updatedRows)
            })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error("An error occurred while saving changes.");
                    }
                })
                .then(data => {
                    console.log(data);
                    if (data.success) {
                        console.log("edit successful!");
                        alert("Edit successful!");

                        setTimeout(function(){
                            window.location.reload();
                        }, 8000); // Reload the table after a successful update
                    } else {
                        displayMarketScan();
                        displayErrorMessage("An error occurred while saving changes.");
                    }
                })
                .catch(error => {
                    console.error(error);
                    displayMarketScan();
                    displayErrorMessage("An error occurred while saving changes.");
                });
        }

        // Click event handler for the "Add Row" button
        $('.add-row-button').click(function() {
            $('#addRowModal').modal('show');
        });

        // Click event handler for the "Add Row" modal's "Add Row" button
        $('#addRowConfirmButton').click(function() {
            // Collect data from input fields
            const newRowData = {
                Num: parseFloat($('#new-num').val()) || 0, // Use 0 as a default value if not provided
                Picks: $('#new-picks').is(":checked"), // Use true/false based on checkbox state
                Captured_in_the_week: $('#new-capturedWeek').val() || " ",
                Date: parseFloat($('#new-date').val()) || parseFloat(new Date().getTime()), // Use current timestamp if not provided
                Lead_type: $('#new-leadType').val() || " ",
                Target_HS_industry_classification: $('#new-HSIndustryClassification').val() || " ",
                Dominant_sector_as_per_MM: $('#new-dominantSectorMM').val() || " ",
                Sectors_as_per_MM: $('#new-sectorsMM').val() || " ",
                Sub_Sectors_as_per_MM: $('#new-subSectorsMM').val() || " ",
                HS_Target_region: $('#new-HSTargetRegion').val() || " ",
                Dominant_country: $('#new-dominantCountry').val() || " ",
                Countries: $('#new-countries').val() || " ",
                Next_Steps: $('#new-nextSteps').val() || " ",
                Target: $('#new-target').val() || " ",
                Target_Chinese: $('#new-targetChinese').val() || " ",
                Deal_intelligence: $('#new-dealIntelligence').val() || " ",
                Short_BD: $('#new-shortBD').val() || " ",
                Bidders: $('#new-bidders').val() || " ",
                Sellers_or_Vendors: $('#new-sellersVendors').val() || " ",
                Type_of_transaction: $('#new-transactionType').val() || " ",
                Intelligence_type_as_per_MM: $('#new-intelligenceType').val() || " ",
                Topics_as_per_MM: $('#new-topicsMM').val() || " ",
                Value_USDm: $('#new-valueUSDm').val() || " ",
                Value_description: $('#new-valueDescription').val() || " ",
                Intelligence_size: $('#new-intelligenceSize').val() || " ",
                Intelligence_size_bucket: $('#new-intelligenceSizeBucket').val() || " ",
                Stake_value_percent: $('#new-stakeValuePercent').val() || " ",
                Held_by_ASPAC_priority_firm_Y_or_N: $('#new-heldByASPAC').val() || " ",
                PE_priority_firm: $('#new-pePriorityFirm').val() || " ",
                Held_since: $('#new-heldSince').val() || " ",
                Held_for_more_than_three_years_Y_N_NA: $('#new-heldThreeYears').val() || " ",
                KPMG_credentials_PE_Company_Both_N: $('#new-kpmgCredentials').val() || " ",
                KPMG_firm: $('#new-kpmgFirm').val() || " ",
                Engagement_partner: $('#new-engagementPartner').val() || " ",
                // Add other fields as needed
            };

            // Send the new row data to the server
            $.ajax({
                url: 'http://127.0.0.1:5003/add_marketscan_row',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(newRowData),
                success: function(response) {
                    if (response.success) {
                        alert('Row added successfully.');
                        // Refresh the table after adding the row
                        setTimeout(function(){
                            window.location.reload();
                        }, 8000); // Reload the table after a successful update
                    } else {
                        alert('Error adding row.');
                    }
                    $('#addRowModal').modal('hide');
                },
                error: function() {
                    alert('Error adding row.');
                    $('#addRowModal').modal('hide');
                }
            });
        });

        
        $(document).on('click', '.expand-button', function () {
            const modalId = $(this).data('bs-target'); // Get the modal's target ID
            const cellContent = $(this).closest('td').data('full-content');
            console.log(cellContent);

            // Find the modal using its unique ID and show it
            $(modalId).find('.modal-body').html(`<div contenteditable="true">${cellContent}</div>`);

            // Add the "editing" class to the cell
            $(modalId).find('.modal-body').addClass('editing');
            
            if (!$(this).closest('td').hasClass('expanded')) {
                // Add the "expanded" class to the cell if it's not already expanded
                $(this).closest('td').addClass('expanded');
            } else {
                // Remove the "expanded" class if it's already expanded (e.g., when closing the modal)
                $(this).closest('td').removeClass('expanded');
            }
            
            $(modalId).modal('show');
        });

        // Initialize an array to keep track of editing cells
        const editingCells = [];

        // Click event handler for cells with contenteditable="true"
        $(document).on('click', '.table td[contenteditable="true"]', function() {
            console.log("This cell is being edited!");
            $(this).addClass('editing');
            // Add the cell to the editingCells array
            editingCells.push(this);
        });

        // Click event handler for #save-changes button
        $(document).on('click', '#save-changes', function() {
            const tableName = $('.table-name').text();
            updateMarketScan();

            // Remove the "editing" and "expanded" classes from all cells in the editingCells array
            editingCells.forEach(function (cell) {
                $(cell).removeClass('editing expanded');
            });

            // Clear the editingCells array
            editingCells.length = 0;
        });

        // Add an event listener to the "Populate MS" button
        $('.populate-RS-button').on('click', function() {
            // Calculate the number of rows in the table
            const numRows = $('#MS_table tbody tr').length;

            // Count the number of "true" values in the "Picks" column
            const numPicks = $('#MS_table tbody td[data-col-name="Picks"]').filter(function() {
                return $(this).text().trim() === 'true';
            }).length;

            // Create the modal content with the updated message
            const modalContent = `
                You are currently going to populate Rolling Shortlist with ${numPicks} rows.
            `;

            // Update the modal body with the content
            $('#populateRS-modal-body').html(modalContent);

            // Show the confirmation modal
            $('#populateRSModal').modal('show');
        });

        // ... (other code)

        // Add an event listener to the "Populate" button in the confirmation modal
        $('#populateRSModalConfirm').on('click', function() {
            // Add logic for populating Rolling Shortlist here
            // This function will be executed when the "Populate" button is clicked in the modal.
            
            // Close the confirmation modal
            $('#populateRSModal').modal('hide');
        });
    });
</script>
</body>
</html>
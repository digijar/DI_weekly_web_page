<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Previewing tables</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
    <style>
        * {
            font-size: 10px;
        }
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f0f0;
        }

        .navbar {
            position: sticky; /* sticky to the top of the page */
            background-color: #6a6a6a;
            border-bottom: 1px solid #ddd;
            position: sticky;
            top: 0;
            z-index: 1000; /* Ensure Navbar is above other content */
        }

        /* Styling the table displayed on the frontend */
        .table {
            width: 100%;
            border-collapse: collapse;
            position: relative;
        }
        .table th,
        .table td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }
        .table td {
            white-space: normal;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .table th {
            position: sticky;
            top: 0px; /* 63px for below navbar */
            background-color: #dbdbdb;
            color: black;
            z-index: 1001;
        }
        .table-details {
            max-width: 800px;
            padding: 0;
        }
        /* CSS to change cell color when editing starts */
        .table td[contenteditable="true"]:focus {
            background-color: orange;
        }
        .table td.expanded div[contenteditable="true"]:focus {
            background-color: orange;
            padding: 8px;
            margin: -8px; /* Counteract padding to maintain cell size */
            border: 1px solid #ccc;
            white-space: normal;
            overflow: visible;
        }
        .table td.expanded {
            background-color: orange;
        }
        .table td.editing {
            background-color: orange;
        }

        /* CSS to style the button container and buttons */
        .button-container {
            display: flex; /* Use flexbox to align buttons horizontally */
            align-items: center; /* Center items vertically within the container */
        }
        .save-button,
        .add-row-button,
        .financials-button,
        .generate-assetpack-button {
            margin-right: 10px; /* Add space between buttons */
        }
        .expand-button {
            border-radius: 10px;
            border: none;
            display: inline-block;
            cursor: pointer;
        }

        /* for SLICER CONTAINER */
        #slicer-container {
            white-space: nowrap;
        }
        .inner-slicer-container {
            display: inline-block;
            max-height: 120px;
            width: 150px;
            border-radius: 10px;
            border: 1px solid #eee;
            padding: 3px;
            margin: 10px;
            overflow: auto; /* Enable vertical scrollbar when content overflows */
            background-color: #fff;
        }
        .slicer {
            padding: 5px;
            border-radius: 5px;
        }
        .slicer-header {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }
        .slicer-options label {
            display: block;
            margin-bottom: 3px;
            color: #333;
        }
        .slicer-options input[type="checkbox"] {
            margin-right: 5px;
        }
        .slicer-options {
            white-space: nowrap; /* Prevent line breaks */
        }

        /* Style the column search input boxes */
        .column-search {
            width: 100%;
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        /* for loading animation */
        .loading-container {
            display: flex;
            justify-content: center;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8); /* Semi-transparent background */
            z-index: 9999; /* Higher z-index to cover the entire page */
        }
        .loading-animation {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container-fluid">
            <!-- Back Button -->
            <a class="navbar-brand" href="/" data-bs-toggle="tooltip" data-bs-title="Go Back">
                <img src="../static/images/left-arrow.png" alt="Back" width="15" height="15">
            </a>

            <!-- Bootstrap's NavBar styling -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarSupportedContent" style="flex-grow: 0;">
                <ul class="navbar-nav nav-tabs">
                    <!-- <li class="nav-item">
                        <a class="nav-link" href="/upload" style="color: white;">Upload</a>
                    </li> -->
                    <li class="nav-item">
                        <a class="nav-link" href="/" style="color: white;">Preview Tables</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/mergermarket" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="MergerMarket" style="color: white;">MM</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/marketscan" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="Market Scan" style="color: white;">MS</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/rollingshortlist" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="Rolling Shortlist">RS</a>
                    </li>
                </ul>
            </div>

            <!-- Table name in the center of the navbar -->
            <div class="table-name mx-auto"></div>

            <!-- Button Container on the top right hand corner of the navbar -->
            <div class="button-container">
                <div class="generate-assetpack-button" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="Generate Asset Pack"></div>
                <div class="add-row-button" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="Add New Row"></div>
                <div class="financials-button" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="Webscrape Company Financials"></div>
                <div class="save-button" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="Save Changes"></div>
                <div class="download-button" data-bs-toggle="tooltip" data-bs-title="Download Rolling Shortlist into Excel"></div>
            </div>
        </div>
    </nav>

    <!-- Modal for Financials -->
    <!-- This Modal has different Modal bodies and footers for different scenarios
            1. if 1 or more targets' checkboxes has been checked
            2. if no targets' checkboxes has been checked aka scrape ALL
    -->
    <div class="modal fade" id="financialsModal" tabindex="-1" aria-labelledby="financialsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="financialsModalLabel">Select Financials to Scrape</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <!-- Modal body when checkboxes are checked -->
                <div class="modal-body" id="modalBodyWithCheckboxes">
                    <p>You have selected <span id="selectedCount">0</span> number of Target's financials to be scraped. Proceed?</p>
                    <p>Targets selected:</p>
                    <ol id="selectedTargets"></ol>
                </div>
                <!-- Modal body when no checkboxes are checked -->
                <div class="modal-body" id="modalBodyNoCheckboxes" style="display: none;">
                    <p>Are you sure you want to scrape ALL the financials?</p>
                </div>
                <div class="modal-footer" id="modalFooterWithCheckboxes">
                    <button type="button" class="btn btn-success" id="proceedAll" onclick="run_webscraper()">Proceed</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
                <div class="modal-footer" id="modalFooterNoCheckboxes" style="display: none;">
                    <button type="button" class="btn btn-danger" id="scrapeAll">Scrape ALL</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for generating Asset Pack -->
    <div class="modal fade" id="generateAPModal" tabindex="-1" aria-labelledby="generateAPModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="generateAPModalLabel">Generate Asset Pack</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <label for="targetNumInput">Target's num for Asset Pack generation:</label>
                    <input type="number" id="targetNumInput" class="form-control" placeholder="Enter Target's Num">
                    <div class="text-danger" id="validationError" style="display: none;">Target is not valid.</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" id="generateAssetPackButton" class="btn btn-primary">Generate</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Modal for adding a new row -->
    <div class="modal fade" id="addRowModal" tabindex="-1" aria-labelledby="addRowModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addRowModalLabel">Add Row</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="max-height: 400px; overflow-y: auto;">
                    <table class="table">
                        <thead>
                            <tr>
                                <!-- Header columns based on the BigQuery Rolling Shortlist table headers -->
                                <th>Num</th>
                                <th>Captured date</th>
                                <th>BP comments</th>
                                <th>Partner_or_Director</th>
                                <th>Target country</th>
                                <th>Sub sector</th>
                                <th>Source</th>
                                <th>Target</th>
                                <th>Business Description</th>
                                <th>Financials</th>
                                <th>Revenue_USD_M</th>
                                <th>EBITDA_USD_M</th>
                                <th>Valuation_USD_M</th>
                                <th>Other Info</th>
                                <th>Deal Intelligence info</th>
                                <th>News Date</th>
                                <th>KPMG View - Redacted</th>
                                <th>Credentials</th>
                                <th>HS contact</th>
                                <th>Investment date</th>
                                <th>Geographic region</th>
                                <th>Asset pack</th>
                                <th>Target Region</th>
                                <th>Shareholders</th>
                                <th>Lead type</th>
                                <th>Target HS industry classification</th>
                                <th>Stake for sale_percent</th>
                                <th>Value_USD_M</th>
                                <th>Value description</th>
                                <th>Website</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <!-- Input fields for each column (follows BigQuery's data types) -->
                                <!-- <td><input type="number" id="new-num"></td> -->
                                <td>
                                    <textarea name="excel_data" style="width:100px;height:20px;" oninput="generateTable()"></textarea>
                                    <input type="number" id="new-num" style="display: none;">
                                </td>
                                <td><input type="date" id="new-capturedDate"></td>
                                <td><input type="text" id="new-bpComments"></td>
                                <td><input type="text" id="new-partnerDirector"></td>
                                <td><input type="text" id="new-targetCountry"></td>
                                <td><input type="text" id="new-subSector"></td>
                                <td><input type="text" id="new-source"></td>
                                <td><input type="text" id="new-target"></td>
                                <td><input type="text" id="new-businessDescription"></td>
                                <td><input type="text" id="new-financials"></td>
                                <td><input type="text" id="new-revenueUSD_M"></td>
                                <td><input type="text" id="new-ebitdaUSD_M"></td>
                                <td><input type="text" id="new-valuationUSD_M"></td>
                                <td><input type="text" id="new-otherInfo"></td>
                                <td><input type="text" id="new-dealIntelligenceInfo"></td>
                                <td><input type="date" id="new-newsDate"></td>
                                <td><input type="text" id="new-kpmgViewRedacted"></td>
                                <td><input type="text" id="new-credentials"></td>
                                <td><input type="text" id="new-hsContact"></td>
                                <td><input type="text" id="new-investmentDate"></td>
                                <td><input type="text" id="new-geographicRegion"></td>
                                <td><input type="text" id="new-assetPack"></td>
                                <td><input type="text" id="new-targetRegion"></td>
                                <td><input type="text" id="new-shareholders"></td>
                                <td><input type="text" id="new-leadType"></td>
                                <td><input type="text" id="new-targetHSIndustryClassification"></td>
                                <td><input type="text" id="new-stakeForSalePercent"></td>
                                <td><input type="text" id="new-valueUSD_M"></td>
                                <td><input type="text" id="new-valueDescription"></td>
                                <td><input type="text" id="new-website"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="addRowConfirmButton">Add Row</button>
                </div>
            </div>
        </div>
    </div>

    <div id="slicer-container">
        <div>
            <button class="btn" type="button" data-bs-toggle="collapse" data-bs-target="#inner-slicer-container" aria-expanded="true" aria-controls="centered-slicer-container">
                <img src="../static/images/Up_arrow.png" width="10" height="10">
            </button>
        </div>
        <!-- Dropdown slicers will be generated here -->
    </div>

    <div class="table-details" style="display: none;">
        <!-- Table Data from BigQuery will be generated here -->
    </div>

    <div class="loading-container">
        <div class="loading-animation"></div>
    </div>

<!-- SheetJS library for Excel file handling -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.4/xlsx.full.min.js"></script>
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" crossorigin="anonymous"></script>
<!-- jQuery for making AJAX requests -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    function generateTable() {
        var data = $('textarea[name=excel_data]').val();
        if (data.length < 4) {
            return;
        }
        var rows = data.split("\t");

        // Remove the 7th position (at index 6) (Repeated Target variable)
        // rows.splice(6, 1);  // Removes 1 element at index 6

        // Mapping of month abbreviations to numeric values
        var monthMap = {
            "Jan": "01",
            "Feb": "02",
            "Mar": "03",
            "Apr": "04",
            "May": "05",
            "Jun": "06",
            "Jul": "07",
            "Aug": "08",
            "Sep": "09",
            "Oct": "10",
            "Nov": "11",
            "Dec": "12"
        };

        if (rows.length > 0) {
            var inputElements = $('#addRowModal input');
            console.log(rows.length +" vs "+ inputElements.length);
            if (rows.length === inputElements.length) {
                for (var i = 0; i < rows.length; i++) {
                    var inputValue = rows[i];

                    // Check if the input field is a number field
                    if (inputElements.eq(i).attr('type') === 'number') {
                        // Parse the value as a number
                        console.log("original num: "+inputValue)
                        inputValue = parseFloat(inputValue);
                        console.log("parsed num: "+inputValue);
                    }

                    // Check if the input field is a date field
                    if (inputElements.eq(i).attr('type') === 'date') {
                        // Convert the date string to the format expected by the date input
                        var dateParts = inputValue.split('-');
                        if (dateParts.length === 3) {
                            var day = parseInt(dateParts[0], 10); // Ensure day is treated as an integer
                            var monthAbbr = dateParts[1];
                            var year = dateParts[2];
                            var month = monthMap[monthAbbr];
                            if (month && day >= 1 && day <= 31) { // Ensure a valid day range
                                day = day < 10 ? '0' + day : day; // Ensure two-digit format
                                inputValue = '20' + year + '-' + month + '-' + day;
                            }
                        }
                        console.log("date: "+inputValue)
                    }
                    inputElements.eq(i).val(inputValue);
                }
                // Hide the current textarea
                $('textarea[name=excel_data]').hide();

                // Show the input number field of the new-opportunityId field
                $('#new-num').show();
            } else {
                alert('Number of columns in the pasted data does not match the number of input fields.');
            }
        } else {
            alert('No data pasted.');
        }
    }

    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
    const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))

    $(document).ready(function() {
        $('#addRowModal').on('hidden.bs.modal', function () {
            // Clear all input values
            $('#addRowModal input').val('');
            $('#addRowModal textarea').val('');
            
            // Show the textarea
            $('textarea[name=excel_data]').show();
            
            // Hide the number input field
            $('#new-num').hide();
        });

        // Add a change event listener to the radio buttons with class "generate-AP-radio"
        $('input.generate-AP-radio').on('change', function() {
            // Uncheck all other radio buttons in the same group
            $('input.generate-AP-radio').not(this).prop('checked', false);
        });
        // Show the loading animation upon loading of the MergerMarket table (time it takes to load the data from BigQuery)
        $('.loading-container').show();
        displayRollingShortlist();

        // To display Rolling Shortlist table
        function displayRollingShortlist() {

            /* The following code is making an AJAX GET request to a local server at
            `http://127.0.0.1:5004/get_rollingshortlist` to fetch data. Once the data is fetched, it
            generates an HTML table using the fetched data and displays it on the webpage. The table
            headers are generated based on the `columnOrder` array, and the table rows are generated
            based on the data received. The code also includes functionality for searching and
            filtering the table data based on user input. Additionally, it appends buttons for
            saving changes, adding rows, asset pack generation, running the financials web scraper */

            $.get(`http://127.0.0.1:5004/get_rollingshortlist`, function(data) {
                // Hide the loading animation upon loading of data from BigQuery
                $('.loading-container').hide();
                tableName = "Rolling_Shortlist"
                const columnOrder = [
                "Num",
                "Captured date",
                "BP comments",
                "Partner_or_Director",
                "Target country",
                "Sub sector",
                "Source",
                " Target",
                "Generate Asset Pack?",
                "Populate Financials?",
                "Business Description",
                "Financials",
                "Revenue_USD_M",
                "EBITDA_USD_M",
                "Valuation_USD_M",
                "Other Info",
                "Deal Intelligence info",
                "News Date",
                "KPMG View - Redacted",
                "Credentials",
                "HS contact",
                "Investment date",
                "Geographic region",
                "Asset pack ",
                "Target Region",
                "Shareholders",
                "Lead type",
                "Target HS industry classification ",
                "Stake for sale_percent",
                "Value_USD_M",
                "Value description ",
                "Website",
                ];
                const tableData = data;
                // Generate a table HTML using the fetched data
                let tableHtml = '<table class="table" id="RS_table">';
                // Generate table headers
                tableHtml += '<thead><tr>';
                for (const columnName of columnOrder) {
                    tableHtml += `
                        <th>${columnName}</th>
                    `;
                }
                tableHtml += '</tr></thead>';

                // For Search text input
                tableHtml += '<thead><tr>';
                for (const columnName of columnOrder) {
                    tableHtml += `
                        <th><input type="text" class="column-search" data-col-name="${columnName}" placeholder="Search ${columnName}"></th>
                    `;
                    
                }
                tableHtml += '</tr></thead>';

                // Generate table rows
                tableHtml += '<tbody>';
                for (const opportunityId in tableData) {
                    const row = tableData[opportunityId];
                    tableHtml += '<tr>';
                    for (const columnName of columnOrder) {
                        if (columnName === "Populate Financials?") {
                            // Add a new column with checkboxes
                            tableHtml += '<td data-col-name="Populate Financials?" contenteditable="false"><input type="checkbox" class="populate-financials-checkbox"></td>';
                        } else if (columnName === "Generate Asset Pack?"){
                            // Add a new column with radios
                            tableHtml += `<td data-col-name="Generate Asset Pack?" contenteditable="false"><input type="radio" class="generate-AP-radio"></td>`;
                        } else {
                            const cellContent = row[columnName];
                            if (cellContent !== null) {
                                if (cellContent.length > 30) {
                                const uniqueID = `modal-${columnName.trim().substring(0, 3)}`;
                                // Create a modal div that's not inside the table
                                tableHtml += `<td data-col-name="${columnName}" data-full-content='${cellContent}'>${cellContent.substring(0, 30)}
                                    <span><button class="expand-button" data-bs-toggle="modal" data-bs-target="#${uniqueID}">...</button></span>
                                </td>`;

                                // Append the modal to the body of the document
                                const modalHtml = `
                                    <div class="modal fade" id="${uniqueID}" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                                        <div class="modal-dialog modal-dialog-scrollable">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body"></div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary close-modal-button" data-bs-dismiss="modal">Close</button>
                                                    <button type="button" id="save-changes" class="btn btn-primary">Save changes</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                                $('body').append(modalHtml); // Append modal to the body
                            } else {
                                    tableHtml += `<td data-col-name="${columnName}" contenteditable="true">${cellContent}</td>`;
                                }
                            } else {
                                tableHtml += `<td data-col-name="${columnName}" contenteditable="true"> </td>`;
                            }
                        }
                    }
                    tableHtml += '</tr>';
                }

                // Add editable attribute to each cell
                tableHtml = tableHtml.replace(/<td>/g, '<td contenteditable="true">');

                // Append table name
                tableNameHtml = `<p style='margin-right: 10px; margin-top: 10px; color: white;'>${tableName}</p>`
                $('.table-name').html(tableNameHtml);

                // Append Save Changes button
                saveHtml = '<button id="save-changes" class="btn"><img src="../static/images/diskette.png" alt="Save Changes" width="15" height="15"></button>';
                $('.save-button').html(saveHtml);

                // Append Add Row button
                addHtml = '<button id="add-row" class="btn"><img src="../static/images/plus.png" alt="Add Row" width="15" height="15"></button>';
                $('.add-row-button').html(addHtml);

                // Append Financials button
                financialsHtml = '<button id="generate-financials" class="btn"><img src="../static/images/dollar.png" alt="Generate Financials" width="15" height="15"></button>';
                $('.financials-button').html(financialsHtml);

                // Append Generate Asset Pack button
                generateHtml = '<button id="generate-assetpack" class="btn"><img src="../static/images/ppt.png" alt="Generate Asset Pack" width="15" height="15"></button>';
                $('.generate-assetpack-button').html(generateHtml);

                // Update the table details placeholder and show it
                $('.table-details').html(tableHtml).show();

                // Hide the tile container
                $('.tile-container').hide();

                // Generate dropdown slicers for each column
                const slicerContainer = document.getElementById("slicer-container");
                slicerHTML = ``;
                for (const columnName of columnOrder) {
                    if (["BP comments", "Geographic region", "Target Region", "Target country", "Source", "Target HS industry classification ", "Lead type", "Credentials"].includes(columnName)) {
                        const uniqueValues = [...new Set(tableData.map(row => row[columnName]))];
                        slicerHTML += `
                        <div class="inner-slicer-container show" id="inner-slicer-container">
                            <div class="slicer">
                                <div class="slicer-header">${columnName}</div>
                                <div class="slicer-options">
                        `
                        function isWhitespace(str) {
                            // Use a regular expression to check for whitespace characters
                            return /^\s*$/.test(str);
                        }
                        for (const value of uniqueValues) {
                            if (!isWhitespace(value)) {
                                slicerHTML += `
                                    <label>
                                        <input type="checkbox" class="slicer-checkbox" value="${value}">${value}
                                    </label>
                                `
                            }
                        }
                        slicerHTML += `
                                </div>
                            </div>
                        </div>
                        `
                    }
                }
                slicerContainer.innerHTML += slicerHTML;

                // Function for Slicer Filtering
                function applySlicerFiltering() {
                    $('.inner-slicer-container').on('input', 'input[type="checkbox"]', function () {
                        // Get all selected slicer values and their corresponding column names
                        const selectedSlicerValues = {};
                        $('.inner-slicer-container').each(function () {
                            const slicerHeading = $(this).find('.slicer-header').text().trim();
                            const selectedValues = [];
                            $(this).find('input[type="checkbox"]:checked').each(function () {
                                selectedValues.push($(this).val());
                            });
                            if (selectedValues.length > 0) {
                                selectedSlicerValues[slicerHeading] = selectedValues;
                                console.log(slicerHeading + ": " + selectedValues);
                            }
                        });
                        // Hide or show table rows based on selected slicer values
                        $('.table tbody tr').each(function () {
                            let rowVisible = true;
                            const $row = $(this);
                            // Check if all selected slicer values match in their respective columns
                            for (const slicerHeading in selectedSlicerValues) {
                                const columnIndex = columnOrder.indexOf(slicerHeading);
                                if (columnIndex !== -1) {
                                    const cellText = $row.find(`td:eq(${columnIndex})`).text().toLowerCase();
                                    const selectedValues = selectedSlicerValues[slicerHeading];
                                    let matchesAllValues = true;
                                    for (const value of selectedValues) {
                                        if (!cellText.includes(value.toLowerCase())) {
                                            matchesAllValues = false;
                                            break;
                                        }
                                    }
                                    if (!matchesAllValues) {
                                        rowVisible = false;
                                        break; // No need to check further
                                    }
                                }
                            }
                            // Toggle row visibility
                            if (rowVisible) {
                                $row.show();
                            } else {
                                $row.hide();
                            }
                        });
                    });
                }

                // For Search Function
                function applyColumnSearch() {
                    $('.column-search').on('input', function () {
                        // Get all search values from all search inputs
                        const searchValues = {};
                        $('.column-search').each(function () {
                            const columnName = $(this).data('col-name');
                            const searchText = $(this).val().toLowerCase();
                            searchValues[columnName] = searchText;
                        });
                        $('.table tbody tr').each(function () {
                            let rowVisible = true;
                            const $row = $(this);
                            // Check if any search text matches in any of the columns
                            for (const columnName of columnOrder) {
                                const cellText = $row.find(`td[data-col-name="${columnName}"]`).text().toLowerCase();
                                const searchText = searchValues[columnName];
                                if (searchText && !cellText.includes(searchText)) {
                                    rowVisible = false;
                                    break;
                                }
                            }
                            // Toggle row visibility
                            if (rowVisible) {
                                $row.show();
                            } else {
                                $row.hide();
                            }
                        });
                    });
                }

                // calling the Slicer and Search functions to apply them to the displayed table
                applySlicerFiltering();
                applyColumnSearch();
                console.log("display successful");

                // FOLLOWING code is to download the BigQuery MergerMarket dataset as an excel file on the user's local machine
                // Create a button element (following this are all DOM manipulation)
                const downloadButton = document.createElement('button');
                downloadButton.id = 'download-button';
                downloadButton.className = 'btn';
                // Create an image element for the button
                const downloadImage = document.createElement('img');
                downloadImage.src = '../static/images/download_icon.png';
                downloadImage.alt = 'Download Table';
                downloadImage.width = 15;
                downloadImage.height = 15;
                downloadButton.appendChild(downloadImage);
                downloadButton.addEventListener('click', async () => {
                    const response = await fetch('http://127.0.0.1:5004/download_rollingshortlist');
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'Rolling Shortlist.xlsx';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                });
                // Append the button to the button container
                const downloadDiv = document.querySelector('.download-button');
                downloadDiv.appendChild(downloadButton);
            });
        }

        // Function to update the Rolling Shortlist table
        function updateRollingShortlist() {
            const editedCells = $('.table td.editing'); // Get all edited cells
            const editedModal = $('.modal-body.editing'); // Get the edited cell inside the modal
            let showAlert = true; // Initialize the showAlert flag as true
            const updatedRows = [];
            if (editedCells.length > 0) {
                showAlert = false;
                editedCells.each(function () {
                const editedCell = $(this);
                const Num = editedCell.closest('tr').find('td:nth-child(1)').text(); // 1st column is Num (unique row number)
                const columnName = editedCell.data('col-name');
                const cellValue = editedCell.text();
                // console.log for debugging purposes
                console.log(Num);
                console.log(columnName);
                console.log(cellValue);
                    updatedRows.push({
                        row_id: Num,
                        column_name: columnName,
                        edited_value: cellValue
                    });
                });
            }
            if (editedModal.length > 0) {
                // Get the updated content from the modal and update the corresponding cell
                const modalId = editedModal.closest('.modal').attr('id'); // Get the modal ID
                const editedContent = $(`#${modalId} .modal-body`).text(); // Get the content from the modal
                const Num = editedModal.closest('tr').find('td:nth-child(1)').text(); // 1st column is Num
                const columnName = editedModal.closest('.table td').data('col-name');
                updatedRows.push({
                    row_id: Num,
                    column_name: columnName,
                    edited_value: editedContent
                });
                showAlert = false; // Modal is edited, so do not show the alert
            }
            // console.log to show developer updated rows during testing
            console.log(updatedRows);
            if (showAlert) {
                alert("No cell is being edited.");
                return;
            }
            // Send the updated data to the backend using fetch
            fetch('http://127.0.0.1:5004/update_rollingshortlist', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updatedRows)
            })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error("An error occurred while saving changes.");
                    }
                })
                .then(data => {
                    console.log(data);
                    if (data.success) {
                        console.log("edit successful!");
                        alert("Edit successful!");
                        setTimeout(function(){
                            window.location.reload();
                        }, 10000); // Reload the table after a successful update
                    } else {
                        displayRollingShortlist();
                        displayErrorMessage("An error occurred while saving changes.");
                    }
                })
                .catch(error => {
                    console.error(error);
                    displayRollingShortlist();
                    displayErrorMessage("An error occurred while saving changes.");
                });
        }

        // FOLLOWING functions are for the Add Row function on the Rolling Shortlist table
        // Click event handler for the "Add Row" button
        $('.add-row-button').click(function() {
            $('#addRowModal').modal('show');
        });
        // Click event handler for the "Add Row" modal's "Add Row" button
        $('#addRowConfirmButton').click(function() {
            // Collect data from input fields
            const newRowData = {
                Num: parseFloat($('#new-num').val()) || 0, // Use 0 as a default value if not provided
                Captured_date: parseFloat($('#new-capturedDate').val()) || parseFloat(new Date().getTime()), // Use current timestamp if not provided
                BP_comments: $('#new-bpComments').val() || " ",
                Partner_or_Director: $('#new-partnerDirector').val() || " ",
                Target_country: $('#new-targetCountry').val() || " ",
                Sub_sector: $('#new-subSector').val() || " ",
                Source: $('#new-source').val() || " ",
                Target: $('#new-target').val() || " ",
                Business_Description: $('#new-businessDescription').val() || " ",
                Financials: $('#new-financials').val() || " ",
                Revenue_USD_M: $('#new-revenueUSD_M').val() || " ",
                EBITDA_USD_M: $('#new-ebitdaUSD_M').val() || " ",
                Valuation_USD_M: $('#new-valuationUSD_M').val() || " ",
                Other_Info: $('#new-otherInfo').val() || " ",
                Deal_Intelligence_info: $('#new-dealIntelligenceInfo').val() || " ",
                News_Date: parseFloat($('#new-newsDate').val()) || parseFloat(new Date().getTime()), // Use current timestamp if not provided
                KPMG_View_Redacted: $('#new-kpmgViewRedacted').val() || " ",
                Credentials: $('#new-credentials').val() || " ",
                HS_contact: $('#new-hsContact').val() || " ",
                Investment_date: $('#new-investmentDate').val() || " ",
                Geographic_region: $('#new-geographicRegion').val() || " ",
                Asset_pack: $('#new-assetPack').val() || " ",
                Target_Region: $('#new-targetRegion').val() || " ",
                Shareholders: $('#new-shareholders').val() || " ",
                Lead_type: $('#new-leadType').val() || " ",
                Target_HS_industry_classification: $('#new-targetHSIndustryClassification').val() || " ",
                Stake_for_sale_percent: $('#new-stakeForSalePercent').val() || " ",
                Value_USD_M: $('#new-valueUSD_M').val() || "",
                Value_description: $('#new-valueDescription').val() || " ",
                Website: $('#new-website').val() || " ",
            };
            // Send the new row data to the server
            $.ajax({
                url: 'http://127.0.0.1:5004/add_rollingshortlist_row',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(newRowData),
                success: function(response) {
                    if (response.success) {
                        alert('Row added successfully.');
                        setTimeout(function(){
                            window.location.reload();
                        }, 10000); // Reload the table after a successful update
                    } else {
                        alert('Error adding row.');
                    }
                    $('#addRowModal').modal('hide');
                },
                error: function() {
                    alert('Error adding row.');
                    $('#addRowModal').modal('hide');
                }
            });
        });

        // FOLLOWING few functions are for the 'Save Changes' functionality
        // Initialize an array to keep track of editing cells
        const editingCells = [];

        // this is for showing a cell's full content in a modal
        $(document).on('click', '.expand-button', function () {
            const modalId = $(this).data('bs-target'); // Get the modal's target ID
            const cellContent = $(this).closest('td').data('full-content');
            console.log(cellContent);
            // Find the modal using its unique ID and show it
            $(modalId).find('.modal-body').html(`<div contenteditable="true">${cellContent}</div>`);
            // Add the "editing" class to the cell
            $(modalId).find('.modal-body').addClass('editing');
            if (!$(this).closest('td').hasClass('expanded')) {
                // Add the "expanded" class to the cell if it's not already expanded
                $(this).closest('td').addClass('expanded');
            } else {
                // Remove the "expanded" class if it's already expanded (e.g., when closing the modal)
                $(this).closest('td').removeClass('expanded');
            }
            $(modalId).modal('show');
        });

        // Click event handler for cells with contenteditable="true"
        $(document).on('click', '.table td[contenteditable="true"]', function() {
            console.log("This cell is being edited!");
            $(this).addClass('editing');
            // Add the cell to the editingCells array
            editingCells.push(this);
        });

        // Click event handler for #save-changes button
        $(document).on('click', '#save-changes', function() {
            const tableName = $('.table-name').text();
            updateRollingShortlist();
            // Remove the "editing" and "expanded" classes from all cells in the editingCells array
            editingCells.forEach(function (cell) {
                $(cell).removeClass('editing expanded');
            });
            // Clear the editingCells array
            editingCells.length = 0;
        });

        // FOLLOWING functions is to connect to the Generate Asset Pack microservice
        function generateAssetPack() {
            const checkedRadio = $('#RS_table tbody input[type="radio"]:checked');
            
            if (checkedRadio.length === 0) {
                alert("Please select a radio button to generate the asset pack.");
                return;
            }
            
            const targetValue = checkedRadio.closest('tr').find('td[data-col-name=" Target"]').text().trim();
            const numValue = checkedRadio.closest('tr').find('td[data-col-name="Num"]').text().trim();
            
            const confirmMessage = `Do you want to generate an asset pack for Target: ${targetValue} and Num: ${numValue}?`;
            
            if (confirm(confirmMessage)) {
                console.log("creating AP...")
                $.ajax({
                    url: `http://127.0.0.1:5010/apgen/${numValue}`,
                    type: 'GET',
                    contentType: 'application/json',
                    // data: JSON.stringify(newRowData),
                    success: function(response) {
                        if (response.success) {
                            alert('Asset Pack created successfully.');
                            setTimeout(function(){
                                window.location.reload();
                            }, 10000); // Reload the table after a successful update
                        } else {
                            alert('Error creating Asset Pack.');
                        }
                    },
                    error: function() {
                        alert('Error creating Asset Pack.');
                    }
                });
            }
        }

        // Attach a click event handler to the .generate-assetpack-button
        $('.generate-assetpack-button').on('click', function() {
            generateAssetPack();
        });

        $(document).on('change', '.generate-AP-radio', function() {
            $('.generate-AP-radio').prop('checked', false); // Uncheck all radio buttons in the column
            $(this).prop('checked', true); // Check the selected radio button
        });

        // FOLLOWING functions is to connect to the Scraping of Financials microservice
        // Function to update the selected count based on checked checkboxes
        function updateSelectedCount() {
            const checkedCheckboxes = $('#RS_table tbody td[data-col-name="Populate Financials?"] input:checked');
            const selectedCount = checkedCheckboxes.length;
            const selectedTargets = checkedCheckboxes.map(function () {
                const cell = $(this).closest('tr').find('td[data-col-name=" Target"]');
                const cellContent = cell.text().trim();
                // Check if the cell has a data-full-content attribute
                const fullContentAttr = cell.attr('data-full-content');
                if (fullContentAttr) {
                    // Use the data-full-content attribute value
                    return fullContentAttr.trim();
                } else {
                    return cellContent;
                }
            }).get();
            // Update the selected count
            $('#selectedCount').text(selectedCount);
            // Update the list of selected Target names
            const targetList = $('#selectedTargets');
            targetList.empty(); // Clear the list
            if (selectedTargets.length > 0) {
                selectedTargets.forEach(function (target) {
                    const listItem = $('<li></li>').text(target);
                    targetList.append(listItem);
                });
            }
            // Show/hide the appropriate modal body and footer based on the number of checkboxes checked
            if (selectedCount > 0) {
                $('#modalBodyWithCheckboxes').show();
                $('#modalFooterWithCheckboxes').show();
                $('#modalBodyNoCheckboxes').hide();
                $('#modalFooterNoCheckboxes').hide();
            } else {
                $('#modalBodyWithCheckboxes').hide();
                $('#modalFooterWithCheckboxes').hide();
                $('#modalBodyNoCheckboxes').show();
                $('#modalFooterNoCheckboxes').show();
            }
        }

        // Button click event to open the initial modal
        $('.financials-button').click(function () {
            updateSelectedCount(); // Update the selected count
            $('#financialsModal').modal('show'); // Show the initial modal
        });
        // Scrape ALL button click event in the initial modal
        $('#scrapeAll').click(function () {
            // Display a confirmation dialog
            const confirmed = confirm("Are you sure you want to scrape ALL financials?");
            // Check if the user confirmed
            if (confirmed) {
                // Close the initial modal
                $('#financialsModal').modal('hide');
                // Perform the "Scrape ALL" action
                // scrapeAllFinancials();
            }
        });
    });

    function run_webscraper(){
        const checkedCheckboxes = $('#RS_table tbody td[data-col-name="Populate Financials?"] input:checked');
        const selectedCount = checkedCheckboxes.length;
        const selectedNums = checkedCheckboxes.map(function () {
            const cellNum = $(this).closest('tr').find('td[data-col-name="Num"]');
            const Num = cellNum.text().trim();
            return parseFloat(Num);
        }).get();
        const selectedTargets = checkedCheckboxes.map(function () {
            const cellTarget = $(this).closest('tr').find('td[data-col-name=" Target"]');
            const Target = cellTarget.text();
            return Target;
        }).get();
        console.log(selectedNums);
        console.log(selectedTargets);
        newTargetData = []
        for (index in selectedNums){
            newTargetData.push({
                num: selectedNums[index],
                target: selectedTargets[index]
            });
        }
        console.log(newTargetData);
        // Send the new row data to the server
        $.ajax({
            url: 'http://127.0.0.1:5009/scrape',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(newTargetData),
            success: function(response) {
                if (response.success) {
                    console.log('webscraper ran successfully.');
                    // Refresh the table after adding the row
                    setTimeout(function(){
                        window.location.reload();
                    }, 10000);
                } else {
                    console.log('webscraper had issue');
                }
            },
            error: function() {
                console.log('webscraper had issue');
            }
        });
    }
</script>
</body>
</html>